# Documentación Técnica del Módulo Split Administration

## 🎯 Descripción General

El módulo Split Administration proporciona gestión integral de infraestructura para recursos de Split.io. Maneja la configuración fundacional requerida antes de desplegar feature flags, incluyendo gestión de workspace, configuración de entornos, definiciones de tipos de tráfico, gestión de segmentos y aprovisionamiento de claves API.

## 🏗️ Descripción General de Arquitectura

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 Arquitectura del Módulo Split Administration           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Gestión de Recursos                         │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Gestión     │  │ Gestión de  │  │ Gestión Tipos       │    │   │
│  │  │ Workspace   │  │ Entornos    │  │ de Tráfico          │    │   │
│  │  │             │  │             │  │                     │    │   │
│  │  │• Crear/Ref  │  │• Multi-env  │  │• Definición Tipo    │    │   │
│  │  │• Etiquetado │  │• Controles  │  │• Config Atributos   │    │   │
│  │  │• Ciclo Vida │  │  Producción │  │• Validación Datos   │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 Gestión de Acceso y Seguridad                  │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Gestión     │  │ Claves de   │  │ Gestión Claves      │    │   │
│  │  │ Segmentos   │  │ Segmento    │  │ API                 │    │   │
│  │  │             │  │ por Entorno │  │                     │    │   │
│  │  │• Definición │  │• Asign Clave│  │• Acceso Basado Rol  │    │   │
│  │  │• Targeting  │  │• Aislamiento│  │• Alcance Entorno    │    │   │
│  │  │• Validación │  │  Entorno    │  │• Controles Seguridad│    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Capa de Integración                        │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Estructura  │  │ Gestión de  │  │ Validación y        │    │   │
│  │  │ de Salidas  │  │ Dependencias│  │ Manejo de Errores   │    │   │
│  │  │             │  │             │  │                     │    │   │
│  │  │• Datos      │  │• Ordenamient│  │• Validación Entrada │    │   │
│  │  │  Estructur. │  │  Recursos   │  │• Checks Dependencia │    │   │
│  │  │• Referencias│  │• Gestión Est│  │• Recuperación Error │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔧 Componentes Centrales

### 1. Gestión de Workspace

El componente workspace proporciona gestión centralizada de workspaces de Split.io con soporte para operaciones de creación y referencia.

#### Características Clave
- **Creación Condicional**: Crear nuevos workspaces o referenciar existentes
- **Soporte de Etiquetado**: Aplicar etiquetas de metadata para organización y gobernanza
- **Gestión de Ciclo de Vida**: Manejar transiciones de estado del workspace

#### Configuración de Recursos
```hcl
resource "split_workspace" "this" {
  count = var.create_workspace ? 1 : 0
  name  = var.workspace_name
  
  dynamic "tags" {
    for_each = var.workspace_tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}

data "split_workspace" "this" {
  count = var.create_workspace ? 0 : 1
  name  = var.workspace_name
}

locals {
  workspace_id = var.create_workspace ? split_workspace.this[0].id : data.split_workspace.this[0].id
}
```

#### Patrones de Diseño
- **Creación Condicional de Recursos**: Usa parámetro count para crear o referenciar
- **Resolución de Valor Local**: Centraliza lógica de resolución ID workspace
- **Propagación de Etiquetas**: Soporta asignación dinámica de etiquetas

### 2. Gestión de Entornos

Soporte multi-entorno con controles de seguridad de producción y opciones de configuración comprehensivas.

#### Características Clave
- **Soporte Multi-Entorno**: Configurar múltiples entornos simultáneamente
- **Controles de Producción**: Manejo especial para entornos de producción
- **Aislamiento de Entornos**: Configuración separada por entorno
- **Gestión de Etiquetas**: Metadata específica por entorno

#### Configuración de Recursos
```hcl
resource "split_environment" "this" {
  for_each = var.environments
  
  workspace_id = local.workspace_id
  name         = each.value.name
  production   = each.value.production
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

### 3. Gestión de Tipos de Tráfico

Define y gestiona tipos de tráfico con soporte para atributos personalizados y validación.

#### Características Clave
- **Definición de Tipos**: Definir tipos de tráfico usuario, cuenta o personalizados
- **Nombres de Presentación**: Nombres legibles para presentación UI
- **Soporte de Atributos**: Atributos personalizados con validación tipo datos
- **Controles de Búsqueda**: Configurar qué atributos son buscables

#### Configuración de Recursos
```hcl
resource "split_traffic_type" "this" {
  for_each = var.traffic_types
  
  workspace_id    = local.workspace_id
  name            = each.value.name
  display_name    = each.value.display_name
}

resource "split_traffic_type_attribute" "this" {
  for_each = var.traffic_type_attributes
  
  workspace_id    = local.workspace_id
  traffic_type_id = split_traffic_type.this[each.value.traffic_type_key].id
  id              = each.value.id
  display_name    = each.value.display_name
  description     = each.value.description
  data_type       = each.value.data_type
  is_searchable   = each.value.is_searchable
  suggested_values = each.value.suggested_values
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

### 4. Gestión de Segmentos

Proporciona capacidades de segmentación de usuarios con características de targeting y validación.

#### Características Clave
- **Definición de Segmentos**: Crear segmentos de usuarios nombrados
- **Asociación Tipo Tráfico**: Vincular segmentos a tipos de tráfico específicos
- **Soporte de Descripción**: Documentar propósito y criterios del segmento
- **Gestión de Etiquetas**: Organizar segmentos con metadata

#### Configuración de Recursos
```hcl
resource "split_segment" "this" {
  for_each = var.segments
  
  workspace_id    = local.workspace_id
  traffic_type_id = split_traffic_type.this[each.value.traffic_type_key].id
  name            = each.value.name
  description     = each.value.description
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

#### Patrones de Diseño de Segmentos
```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Patrones de Arquitectura de Segmentos               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Segmentos de Negocio:                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Usuarios Premium     • Regiones Geográficas                   │   │
│  │ • Beta Testers         • Niveles Cliente                        │   │
│  │ • Usuarios Internos    • Tipos Suscripción                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Segmentos Técnicos:                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Tipos Dispositivo    • Versiones Aplicación                   │   │
│  │ • Capacidades Browser  • Niveles Rendimiento                    │   │
│  │ • Condiciones Red      • Compatibilidad Features                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Segmentos Operacionales:                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Testing Carga        • Despliegues Canary                     │   │
│  │ • Recuperación Error   • Ventanas Mantenimiento                 │   │
│  │ • Gestión Capacidad    • Respuesta Emergencia                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5. Claves de Segmento por Entorno

Gestiona la asignación de claves específicas a segmentos dentro de entornos.

#### Características Clave
- **Aislamiento de Entornos**: Conjuntos de claves separados por entorno
- **Gestión Dinámica de Claves**: Agregar/remover claves según necesario
- **Operaciones en Lote**: Gestionar múltiples claves eficientemente
- **Validación**: Asegurar consistencia y formato de claves

#### Configuración de Recursos
```hcl
resource "split_environment_segment_keys" "this" {
  for_each = var.environment_segment_keys
  
  workspace_id   = local.workspace_id
  environment_id = split_environment.this[each.value.environment_key].id
  segment_name   = each.value.segment_name
  keys           = each.value.keys
}
```

### 6. Gestión de Claves API

Gestión segura de claves API con control de acceso basado en roles.

#### Características Clave
- **Acceso Basado en Roles**: Asignar roles específicos a claves API
- **Alcance de Entorno**: Claves con alcance a entornos específicos
- **Gestión de Tipos**: Soporte para tipos de claves servidor, cliente y móvil
- **Controles de Seguridad**: Rotación automatizada de claves y logging de acceso

#### Configuración de Recursos
```hcl
resource "split_api_key" "this" {
  for_each = var.api_keys
  
  workspace_id   = local.workspace_id
  environment_id = split_environment.this[each.value.environment_key].id
  name           = each.value.name
  type           = each.value.type
  roles          = each.value.roles
}
```

#### Tipos de Claves API y Roles
```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Matriz Gestión Claves API                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│             │ Claves Servidor │ Claves Cliente │                        │
│             │      🖥️         │      🌐         │                        │
│  ───────────┼─────────────────┼────────────────┼                        │
│  Admin      │      ✅         │      ❌         │ Acceso                 │
│  Read       │      ✅         │      ✅         │ Solo                   │
│  Write      │      ✅         │      ⚠️         │ Limitado               │
│  SDK        │      ✅         │      ✅         │ Evaluar                │
│                                                                         │
│  Leyenda:                                                               │
│  ✅ = Recomendado    ⚠️ = Usar con precaución    ❌ = No recomendado     │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Flujo de Datos y Dependencias

### Orden de Creación de Recursos
```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Flujo de Creación de Recursos                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. Workspace ──┐                                                       │
│                 │                                                       │
│                 ▼                                                       │
│  2. Entornos ──┐                                                        │
│                │                                                        │
│                ▼                                                        │
│  3. Tipos de Tráfico ──┐                                                │
│                        │                                                │
│                        ▼                                                │
│  4. Atributos Tipos Tráfico ──┐                                         │
│                               │                                         │
│                               ▼                                         │
│  5. Segmentos ──┐                                                       │
│                 │                                                       │
│                 ▼                                                       │
│  6. Claves Segmento por Entorno ──┐                                     │
│                                   │                                     │
│                                   ▼                                     │
│  7. Claves API                                                          │
│                                                                         │
│  Dependencias:                                                          │
│  • Cada recurso depende de workspace_id                                │
│  • Entornos proporcionan environment_id para recursos subsecuentes     │
│  • Tipos tráfico proporcionan traffic_type_id para atributos/segmentos │
│  • Segmentos proporcionan contexto para claves segmento por entorno    │
└─────────────────────────────────────────────────────────────────────────┘
```

### Pruebas de Integración
```bash
echo "Iniciando Pruebas Integración Split Administration..."

# Prueba 1: Inicialización módulo
echo "Prueba 1: Inicialización Módulo"
terraform init -upgrade
terraform validate

# Prueba 2: Generación plan
echo "Prueba 2: Generación Plan"
terraform plan -var-file="test.tfvars" -out=test.plan

# Prueba 3: Creación recursos
echo "Prueba 3: Creación Recursos"
terraform apply -auto-approve test.plan

# Prueba 4: Validación estado
echo "Prueba 4: Validación Estado"
terraform show -json | jq '.values.root_module.resources[] | select(.type == "split_workspace")'

# Prueba 5: Validación salidas
echo "Prueba 5: Validación Salidas"
WORKSPACE_ID=$(terraform output -raw workspace_id)
if [ -z "$WORKSPACE_ID" ]; then
  echo "ERROR: ID Workspace no encontrado en salidas"
  exit 1
fi

# Prueba 6: Limpieza
echo "Prueba 6: Limpieza"
terraform destroy -auto-approve -var-file="test.tfvars"

echo "¡Todas las pruebas pasaron exitosamente!"
```

Esta documentación técnica comprehensiva proporciona insights profundos sobre la arquitectura, componentes y aspectos operacionales del módulo Split Administration. El módulo está diseñado para despliegues a escala empresarial con seguridad, rendimiento y mantenibilidad como preocupaciones primarias.
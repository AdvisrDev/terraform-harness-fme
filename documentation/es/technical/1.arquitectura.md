# Arquitectura T√©cnica - M√≥dulos de Terraform para Gesti√≥n de Caracter√≠sticas y Experimentaci√≥n (FME)

Este documento proporciona una visi√≥n t√©cnica completa de la arquitectura del m√≥dulo Terraform para gestionar banderas de caracter√≠sticas FME y la infraestructura de administraci√≥n en m√∫ltiples entornos.

## üèóÔ∏è Resumen de la Arquitectura del M√≥dulo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     M√≥dulo Ra√≠z de Terraform FME                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                          L√≥gica Condicional                             ‚îÇ
‚îÇ                    length(var.feature_flags) == 0                      ‚îÇ
‚îÇ                               ‚Üì                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   split-feature-flags    ‚îÇ    ‚îÇ    split-administration          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   [count = 0 o 1]        ‚îÇ    ‚îÇ    [count = 0 o 1]               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Activado cuando:        ‚îÇ    ‚îÇ  Activado cuando:                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ feature_flags tiene   ‚îÇ    ‚îÇ  ‚Ä¢ feature_flags est√° vac√≠o      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    contenido (length > 0)‚îÇ    ‚îÇ    (length == 0)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Variables de Entrada:   ‚îÇ    ‚îÇ  Variables de Entrada:           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ workspace             ‚îÇ    ‚îÇ  ‚Ä¢ environment_name              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ environment_name      ‚îÇ    ‚îÇ  ‚Ä¢ workspace                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ traffic_type_name     ‚îÇ    ‚îÇ  ‚Ä¢ environments                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ feature_flags[]       ‚îÇ    ‚îÇ  ‚Ä¢ traffic_types                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ  ‚Ä¢ segments                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Caracter√≠sticas Principales:‚îÇ    ‚îÇ  ‚Ä¢ api_keys[]                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Filtrado de Entornos  ‚îÇ    ‚îÇ  ‚Ä¢ environment_segment_keys[]    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Fusi√≥n de Config      ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Validaci√≥n            ‚îÇ    ‚îÇ  Caracter√≠sticas Principales:    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ  ‚Ä¢ Filtrado de Entornos          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Salida:                 ‚îÇ    ‚îÇ  ‚Ä¢ Fusi√≥n de Config para claves ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Splits de Banderas    ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Definiciones de Split ‚îÇ    ‚îÇ  Salida:                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  ‚Ä¢ Recursos de Infraestructura   ‚îÇ   ‚îÇ
‚îÇ                                  ‚îÇ  ‚Ä¢ Claves API, claves de segmento‚îÇ   ‚îÇ
‚îÇ                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Salidas del M√≥dulo Ra√≠z: Condicional seg√∫n el m√≥dulo activo            ‚îÇ
‚îÇ  ‚Ä¢ length(module.split_administration) > 0 ? admin_outputs : null      ‚îÇ
‚îÇ  ‚Ä¢ length(module.feature_flags) > 0 ? feature_outputs : null           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üß© Componentes Principales

### 1\. M√≥dulo split-feature-flags

Gestiona los splits y definiciones de banderas de caracter√≠sticas con configuraciones espec√≠ficas por entorno.

#### Caracter√≠sticas Clave

  - **Filtrado de Entornos**: Solo despliega banderas en los entornos especificados
  - **Fusi√≥n de Configuraciones**: Fusiona configuraciones base con anulaciones de entorno
  - **Configuraci√≥n Flexible**: Mismos tratamientos en todos los entornos O diferentes por entorno

#### Estructura de Variables

```hcl
variable "feature_flags" {
  type = list(object({
    name              = string
    description       = string
    default_treatment = string
    environments      = list(string)
    lifecycle_stage   = string
    category          = string
    
    treatments = list(object({
      name           = string
      configurations = string
      description    = string
    }))
    
    rules = list(object({
      treatment = string
      size      = number
      condition = object({
        matcher = object({
          type      = string
          attribute = string
          strings   = list(string)
        })
      })
    }))
    
    # Anulaciones espec√≠ficas por entorno
    environment_configs = map(object({
      default_treatment = string
      description       = string
      treatments        = list(object({...}))
      rules            = list(object({...}))
    }))
  }))
}
```

### 2\. M√≥dulo split-administration

Gestiona el espacio de trabajo (workspace), entornos, tipos de tr√°fico, segmentos, claves API y claves de segmento.

#### Caracter√≠sticas Clave

  - **Filtrado de Entornos**: Filtra claves API y claves de segmento por entorno
  - **Fusi√≥n de Configuraciones**: Fusiona configuraciones base con anulaciones espec√≠ficas por entorno
  - **Gesti√≥n de Infraestructura**: Crea y gestiona la infraestructura de Split.io

#### Estructura de Variables

```hcl
variable "api_keys" {
  type = list(object({
    name         = string
    type         = string
    roles        = list(string)
    environments = list(string)
    environment_configs = map(object({
      name  = string
      type  = string
      roles = list(string)
    }))
  }))
}

variable "environment_segment_keys" {
  type = list(object({
    name         = string
    segment_name = string
    keys         = list(string)
    environments = list(string)
    environment_configs = map(object({
      keys = list(string)
    }))
  }))
}
```

## üîÑ Patr√≥n de Filtrado de Entornos

Ambos m√≥dulos utilizan el mismo patr√≥n de filtrado de entornos:

```hcl
# Filtrar elementos para el entorno actual
environment_items = [
  for item in var.items : item
  if length(item.environments) == 0 || contains(item.environments, var.environment_name)
]

# Fusionar configuraci√≥n base con anulaciones de entorno
merged_items = [
  for item in local.environment_items : {
    name = try(item.environment_configs[var.environment_name].name, item.name)
    # ... otras propiedades con fallback try()
  }
]
```

## üìä Motor de Fusi√≥n de Configuraciones

### Flujo de L√≥gica de Fusi√≥n

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Motor de Fusi√≥n de Configuraciones                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  Entrada: items[] + current_environment                                 ‚îÇ
‚îÇ                                     ‚îÇ                                   ‚îÇ
‚îÇ                                     ‚ñº                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                Para Cada Elemento                               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  1. Comenzar con configuraci√≥n base                             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ name: "api-key"                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ type: "server_side"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ roles: ["API_FEATURE_FLAG_VIEWER"]                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  2. Verificar anulaciones espec√≠ficas por entorno               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     environment_configs["prod"]: {                              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       name: "prd-api-key"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     }                                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  3. Aplicar l√≥gica de fusi√≥n con funci√≥n try()                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     merged_config = {                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       name: try(override.name, base.name)                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       type: try(override.type, base.type)                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       roles: try(override.roles, base.roles)                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     }                                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  4. Resultado: Configuraci√≥n final fusionada                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ name: "prd-api-key"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ type: "server_side"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]           ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Patrones de Extensi√≥n

### 1\. Agregar Nuevas Propiedades Espec√≠ficas por Entorno

```hcl
# En variables.tf
environment_configs = map(object({
  # Propiedades existentes
  name  = optional(string)
  type  = optional(string)
  roles = optional(list(string))
}))

# En main.tf locals
merged_items = [
  for item in local.environment_items : {
    name = try(item.environment_configs[var.environment_name].name, item.name)
  }
]
```

### 2\. Agregar Validaci√≥n Personalizada

```hcl
variable "api_keys" {
  # ... definici√≥n de tipo
  
  validation {
    condition = alltrue([
      for key in var.api_keys :
      key.type == "admin" ? contains(key.roles, "API_ALL_GRANTED") : true
    ])
    error_message = "Las claves API de administrador deben tener el rol API_ALL_GRANTED"
  }
}
```

### 3\. Creaci√≥n de Recursos Espec√≠ficos por Entorno

```hcl
# Filtrar y crear recursos solo para el entorno actual
resource "split_api_key" "this" {
  for_each = local.api_keys_map
  
  workspace_id    = local.workspace_id
  environment_ids = [local.environment_id]
  name            = each.value.name
  type            = each.value.type
  roles           = each.value.roles
}
```

## üìà Patrones de Uso

### 1\. Patr√≥n de Configuraci√≥n Com√∫n

```hcl
# common.tfvars
api_keys = [
  {
    name = "server"
    type = "server_side"
    roles = ["API_FEATURE_FLAG_VIEWER"]
    environments = ["dev", "staging", "prod"]
    environment_configs = {
      dev = { name = "dev-server" }
      staging = { name = "stg-server" }
      prod = { name = "prd-server" }
    }
  }
]
```

### 2\. Patr√≥n de Configuraci√≥n Espec√≠fica por Entorno

```hcl
# environments/development.tfvars
environment_name = "dev"

# Elementos solo para desarrollo
api_keys = [
  {
    name = "debug"
    type = "admin"
    roles = ["API_ALL_GRANTED"]
    environments = ["dev"]
  }
]
```

### 3\. Patr√≥n de Consumo de M√≥dulos

```hcl
# main.tf del m√≥dulo ra√≠z - consume m√≥dulos locales de la carpeta modules/
module "split_administration" {
  source = "./modules/split-administration"
  count  = length(var.feature_flags) == 0 ? 1 : 0

  environment_name         = var.environment_name
  workspace                = var.workspace
  environments             = var.environments
  traffic_types            = var.traffic_types
  traffic_type_attributes  = var.traffic_type_attributes
  segments                 = var.segments
  environment_segment_keys = var.environment_segment_keys
  api_keys                 = var.api_keys
}

module "feature_flags" {
  source = "./modules/split-feature-flags"
  count  = length(var.feature_flags) > 0 ? 1 : 0

  workspace         = var.workspace
  environment_name  = var.environment_name
  traffic_type_name = var.traffic_type_name
  feature_flags     = var.feature_flags
}

# main.tf del caso de uso - consume el m√≥dulo ra√≠z para administraci√≥n
module "banking_administration" {
  source = "../../"
  
  environment_name         = var.environment_name
  workspace                = var.workspace
  environments             = var.environments
  traffic_types            = var.traffic_types
  traffic_type_attributes  = var.traffic_type_attributes
  segments                 = var.segments
  environment_segment_keys = var.environment_segment_keys
  api_keys                 = var.api_keys
  
  # feature_flags vac√≠o activa el modo de administraci√≥n
  feature_flags = []
}

# main.tf del caso de uso - consume el m√≥dulo ra√≠z para banderas de caracter√≠sticas
module "banking_feature_flags" {
  source = "../../"
  
  workspace         = var.workspace
  environment_name  = var.environment_name
  traffic_type_name = var.traffic_type_name
  
  # feature_flags no vac√≠o activa el modo de banderas de caracter√≠sticas
  feature_flags = var.feature_flags
}
```

## üîÑ Patr√≥n de Salidas Condicionales

El m√≥dulo ra√≠z implementa salidas condicionales que se adaptan al m√≥dulo activo:

```hcl
# outputs.tf del m√≥dulo ra√≠z - Patr√≥n de salida condicional
output "workspace_id" {
  description = "ID del workspace de Harness FME"
  value       = length(module.split_administration) > 0 ? module.split_administration[0].workspace_id : null
}

output "feature_flags_list" {
  description = "Lista de banderas de caracter√≠sticas creadas con sus detalles"
  value       = length(module.feature_flags) > 0 ? module.feature_flags[0].feature_flags : {}
}

output "deployment_summary" {
  description = "Resumen del despliegue completo"
  value = {
    environment_name = var.environment_name
    workspace_name   = var.workspace.name
    administration = length(module.split_administration) > 0 ? {
      workspace_created   = module.split_administration[0].workspace_id != null
      environments_count  = length(module.split_administration[0].environment_ids)
      traffic_types_count = length(module.split_administration[0].traffic_type_ids)
      segments_count      = length(module.split_administration[0].segment_ids)
      api_keys_count      = length(module.split_administration[0].api_keys)
    } : null
    feature_flags = length(module.feature_flags) > 0 ? {
      total_flags_count       = length(module.feature_flags[0].feature_flags)
      environment_flags_count = length(module.feature_flags[0].filtered_feature_flags)
      merged_flags_count      = length(module.feature_flags[0].merged_feature_flags)
    } : null
  }
}
```

**Beneficios:**

  - **Degradaci√≥n Elegante**: Las salidas devuelven nulo para m√≥dulos inactivos en lugar de errores
  - **Adaptaci√≥n Din√°mica**: La estructura de salida cambia seg√∫n la funcionalidad activa
  - **Consumo Limpio**: Los casos de uso obtienen las salidas relevantes sin condicionales

## üõ°Ô∏è Mejores Pr√°cticas

### 1\. Seguridad del Entorno

  - Usar el array `environments` para controlar el alcance del despliegue
  - Validar los nombres de entorno con los valores permitidos
  - Usar anulaciones espec√≠ficas de entorno para configuraciones de seguridad

### 2\. Gesti√≥n de la Configuraci√≥n

  - Definir configuraciones comunes en `common.tfvars`
  - Usar archivos espec√≠ficos de entorno solo para elementos √∫nicos del entorno
  - Aprovechar `environment_configs` para anulaciones espec√≠ficas de entorno

### 3\. Estrategia de Validaci√≥n

  - Implementar reglas de validaci√≥n completas
  - Usar validaciones de Terraform para retroalimentaci√≥n inmediata
  - Validar referencias cruzadas entre configuraciones

Esta arquitectura proporciona una base s√≥lida para gestionar la infraestructura y las banderas de caracter√≠sticas de Split.io a escala, manteniendo la seguridad, el rendimiento y la mantenibilidad.
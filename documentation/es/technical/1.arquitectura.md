# Arquitectura Técnica - Harness Feature Management and Experimentation (FME)

Este documento proporciona una descripción técnica completa de la arquitectura del módulo de Terraform para gestionar feature flags a través de múltiples entornos.

## 🏗️ Resumen de Arquitectura del Módulo

```
┌───────────────────────────────────────────────────────────────────────────┐
│                      Módulo Terraform de FME                              │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────┐    ┌─────────────────────────────────────┐   │
│  │  Variables de Entrada   │    │     Procesamiento Central           │   │
│  │                         │    │                                     │   │
│  │  • workspace_name       │    │  ┌─────────────────────────────┐    │   │
│  │  • environment_name     │───▶│  │   Filtrado de Entornos      │    │   │
│  │  • is_production        │    │  └─────────────────────────────┘    │   │
│  │  • traffic_type_name    │    │                 │                   │   │
│  │  • feature_flags[]      │    │                 ▼                   │   │
│  │                         │    │  ┌─────────────────────────────┐    │   │
│  └─────────────────────────┘    │  │ Fusión de Configuraciones   │    │   │
│                                 │  │ Específicas por Entorno     │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 │                 │                   │   │
│                                 │                 ▼                   │   │
│                                 │  ┌─────────────────────────────┐    │   │
│                                 │  │    Motor de Validación      │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 │                 │                   │   │
│                                 │                 ▼                   │   │
│                                 │  ┌─────────────────────────────┐    │   │
│                                 │  │   Generación de Recursos    │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 └─────────────────────────────────────┘   │
│                                                 │                         │
│                                                 ▼                         │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │                         Terraform Resources                     │     │
│   │                                                                 │     │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │     │
│   │  │  Workspace  │  │ Environment │  │    Feature Flags        │  │     │
│   │  │   (Data)    │  │ (Resource)  │  │     (Resources)         │  │     │
│   │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │     │
│   │                                                                 │     │
│   │  ┌─────────────┐  ┌─────────────────────────┐                   │     │
│   │  │Traffic Type │  │    Feature Flag         │                   │     │
│   │  │   (Data)    │  │     Definitions         │                   │     │
│   │  │             │  │     (Resources)         │                   │     │
│   │  └─────────────┘  └─────────────────────────┘                   │     │
│   └─────────────────────────────────────────────────────────────────┘     │
│                                                  │                        │
│                                                  ▼                        │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │                      Outputs                                    │     │
│   │                                                                 │     │
│   │  • workspace_id              • filtered_feature_flags           │     │
│   │  • environment_id            • merged_feature_flags             │     │
│   │  • feature_flags_summary     • environment_specific_configs     │     │
│   └─────────────────────────────────────────────────────────────────┘     │
└───────────────────────────────────────────────────────────────────────────┘
```

## 🧩 Componentes Centrales

### 1. Capa de Procesamiento de Entrada

#### Estructura de Variables
El módulo acepta una estructura de variables compleja que soporta configuraciones base y específicas por entorno:

```hcl
variable "feature_flags" {
  type = list(object({
    # Atributos centrales
    name              = string
    description       = string
    default_treatment = string
    environments      = optional(list(string), ["dev", "staging", "prod"])
    lifecycle_stage   = optional(string, "development")
    category          = optional(string, "feature")
    
    # Configuración base
    treatments = list(object({
      name           = string
      configurations = optional(string, "{}")
      description    = optional(string, "")
    }))
    
    rules = optional(list(object({
      treatment = optional(string)
      size      = optional(number, 100)
      condition = optional(object({
        matcher = object({
          type      = string
          attribute = string
          strings   = optional(list(string), [])
        })
      }))
    })), [])
    
    # Configuraciones específicas por entorno
    environment_configs = optional(map(object({
      default_treatment = optional(string)
      description       = optional(string)
      treatments        = optional(list(object({...})))
      rules            = optional(list(object({...})))
    })), {})
  }))
}
```

#### Motor de Validación
```
┌────────────────────────────────────────────────────────┐
│                Motor de Validación                     │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────────┐  ┌─────────────────────────┐     │
│  │Validación Básica │  │ Validación de Entornos  │     │
│  │                  │  │                         │     │
│  │ • Nombre no vacío│  │ • Entornos válidos      │     │
│  │ • Descripción    │  │ • Consistencia config   │     │
│  │ • Treatments≥2   │  │ • Integridad referenc.  │     │
│  │ • Default existe │  │ • Límites tamaño regla  │     │
│  └──────────────────┘  └─────────────────────────┘     │
│           │                        │                   │
│           └────────────┬───────────┘                   │
│                        │                               │
│                        ▼                               │
│  ┌────────────────────────────────────────────────┐    │
│  │        Validación Avanzada                     │    │
│  │                                                │    │
│  │ • Validez de etapa del ciclo de vida           │    │
│  │ • Clasificación de categorías                  │    │
│  │ • Unicidad entre los nombres de los treatments │    │
│  │ • Validación de porcentajes de reglas          │    │
│  └────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────┘
```

### 2. Motor de Filtrado de Entornos

El motor de filtrado de entornos determina qué feature flags deben desplegarse en el entorno actual:

```
┌────────────────────────────────────────────────────────────────┐
│               Motor de Filtrado de Entornos                    │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Entrada: feature_flags[] + entorno_actual                     │
│                                │                               │
│                                ▼                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           Verificación de Entorno                       │   │
│  │                                                         │   │
│  │  para cada feature_flag:                                │   │
│  │    si entorno_actual en flag.environments:              │   │
│  │      √ Incluir en despliegue                            │   │
│  │    sino:                                                │   │
│  │      x Omitir (filtro de seguridad)                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                │                               │
│                                ▼                               │
│  Salida: environment_feature_flags[]                           │
│                                                                │
│  Ejemplo:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Flag A: environments = ["dev", "staging", "prod"]       │   │
│  │ Flag B: environments = ["dev", "staging"]               │   │
│  │ Flag C: environments = ["dev"]                          │   │
│  │                                                         │   │
│  │ Entorno Actual: "prod"                                  │   │
│  │ Resultado: [Flag A] √                                   │   │
│  │           Flag B x (no está en prod)                    │   │
│  │           Flag C x (no está en prod)                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────┘
```

### 3. Motor de Fusión de Configuraciones

El componente más sofisticado maneja la fusión de configuraciones base con configuraciones específicas por entorno:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  Motor de Fusión de Configuraciones                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Entrada: filtered_feature_flags[] + entorno_actual                     │
│                                     │                                   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                Para Cada Feature Flag                           │    │
│  │                                                                 │    │
│  │  1. Comenzar con configuración base                             │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ Config Base:                                        │     │    │
│  │     │ • name: "api-limiting"                              │     │    │
│  │     │ • description: "Limitación de API"                  │     │    │
│  │     │ • default_treatment: "standard"                     │     │    │
│  │     │ • treatments: [standard, off]                       │     │    │
│  │     │ • rules: []                                         │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  2. Verificar configuraciones específicas por entorno           │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ environment_configs["prod"]: {                      │     │    │
│  │     │   description: "Limitación API prod con seguridad"  │     │    │
│  │     │   treatments: [enhanced_standard, off]              │     │    │
│  │     │   rules: [premium_user_rule]                        │     │    │
│  │     │ }                                                   │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  3. Aplicar lógica de fusión con función try()                  │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ merged_config = {                                   │     │    │
│  │     │   name: base.name                                   │     │    │
│  │     │   description: try(override.description,            │     │    │
│  │     │                     base.description)               │     │    │
│  │     │   treatments: try(override.treatments,              │     │    │
│  │     │                   base.treatments)                  │     │    │
│  │     │   rules: try(override.rules, base.rules)            │     │    │
│  │     │ }                                                   │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  4. Resultado: Configuración final fusionada                    │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ Config Final:                                       │     │    │
│  │     │ • name: "api-limiting"                              │     │    │
│  │     │ • description: "Limitación API prod con seguridad"  │     │    │
│  │     │ • treatments: [enhanced_standard, off]              │     │    │
│  │     │ • rules: [premium_user_rule]                        │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                     │                                   │
│                                     ▼                                   │
│  Salida: merged_feature_flags[]                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Arquitectura de Flujo de Datos

### Pipeline de Procesamiento

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Variables  │    │ Filtrado de │    │Fusión de    │    │ Generación  │
│  de Entrada │───▶│  Entornos   │───▶│Configuración│───▶│ de Recursos │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│feature_flags│    │environment_ │    │  merged_    │    │split_split  │
│     []      │    │feature_flags│    │feature_flags│    │split_split_ │
│             │    │     []      │    │     []      │    │definition   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                 │
                                                                 ▼
                                                         ┌─────────────┐
                                                         │   Salidas   │
                                                         │             │
                                                         └─────────────┘
```

### Flujo de Variables Locales de terraform

```hcl
locals {
  # 1. Filtrado de entornos
  environment_feature_flags = [
    for ff in var.feature_flags : ff
    if contains(ff.environments, var.environment_name)
  ]
  
  # 2. Fusión de configuraciones
  merged_feature_flags = [
    for ff in local.environment_feature_flags : {
      name = ff.name
      description = try(
        ff.environment_configs[var.environment_name].description,
        ff.description
      )
      default_treatment = try(
        ff.environment_configs[var.environment_name].default_treatment,
        ff.default_treatment
      )
      treatments = try(
        ff.environment_configs[var.environment_name].treatments,
        ff.treatments
      )
      rules = try(
        ff.environment_configs[var.environment_name].rules,
        ff.rules
      )
      # Metadatos para seguimiento
      _original_config = ff
      _environment_config = try(
        ff.environment_configs[var.environment_name],
        null
      )
    }
  ]
  
  # 3. Mapeo de recursos
  feature_flags_map = {
    for ff in local.merged_feature_flags : ff.name => ff
  }
}
```

## 🛡️ Arquitectura de Seguridad

### Validación de Entrada

```
┌────────────────────────────────────────────────────────────────────────┐
│                    Capa de Validación de Seguridad                     │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 Sanitización de Entrada                         │   │
│  │                                                                 │   │
│  │  • Todas las entradas de string validadas por longitud          │   │
│  │  • No se permiten nombres o descripciones vacías                │   │
│  │  • Nombres de treatments únicos dentro del flag                 │   │
│  │  • Treatment por defecto debe existir en lista de treatments    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                Seguridad de Entornos                            │   │
│  │                                                                 │   │
│  │  • Configs de entorno solo referencian entornos permitidos      │   │
│  │  • Bandera de producción configurada correctamente              │   │
│  │  • Nombres de entorno validados contra lista permitida          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │             Validación de Lógica de Negocio                     │   │
│  │                                                                 │   │
│  │  • Etapas del ciclo de vida deben ser valores válidos           │   │
│  │  • Categorías deben ser de lista aprobada                       │   │
│  │  • Porcentajes de reglas entre 0-100                            │   │
│  │  • Validación de estructura JSON de configuración               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

### Aislamiento de Entornos

```
Entorno Dev              Entorno Staging           Entorno Producción
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│ • Flags debug   │      │ • Flags prueba  │      │ • Flags prod    │
│ • Límites altos │ ───▶ │ • Monitoreo     │ ───▶ │ • Seguridad     │
│ • Datos mock    │      │ • Analíticas    │      │ • Logs auditoría│
│ • Experimental  │      │ • Pruebas A/B   │      │ • Conservador   │
│                 │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
        ▲                         ▲                         ▲
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
                    ┌─────────────────────────┐
                    │  Motor Filtro Seguridad │
                    │                         │
                    │ • Verificaciones entorno│
                    │ • Fusión configuración  │
                    │ • Control de acceso     │
                    └─────────────────────────┘
```

## 📊 Consideraciones de Rendimiento

### Estrategia de Creación de Recursos

El módulo usa el meta-argumento `for_each` de Terraform para gestión eficiente de recursos:

```hcl
# Creación eficiente de recursos
resource "split_split" "this" {
  for_each = local.feature_flags_map  # Operación O(n)
  # ... configuración de recursos
}

# En lugar de múltiples recursos individuales que serían O(n²)
```

## 🔧 Puntos de Extensión

### Validación Personalizada

El módulo proporciona puntos de extensión para validación personalizada:

```hcl
# Ejemplo de validación personalizada
variable "feature_flags" {
  validation {
    condition = alltrue([
      for ff in var.feature_flags :
      # Validación de regla de negocio personalizada
      ff.category == "killswitch" ? ff.default_treatment == "off" : true
    ])
    error_message = "Los flags killswitch deben defaultear a 'off'"
  }
}
```

## 📈 Arquitectura de Escalabilidad

### Escalado Horizontal

```
Arquitectura Multi-Workspace:
┌───────────────────────────────────────────────────────────────┐
│                                                               │
│  Workspace A        Workspace B        Workspace C            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ Producto A  │    │ Producto B  │    │ Producto C  │        │
│  │ Flags       │    │ Flags       │    │ Flags       │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│         │                   │                   │             │
│         └───────────────────┼───────────────────┘             │
│                             │                                 │
│         ┌───────────────────────────────────────┐             │
│         │        Núcleo de Módulo Compartido    │             │
│         │                                       │             │
│         │  • Filtrado de entornos               │             │
│         │  • Fusión de configuraciones          │             │
│         │  • Motor de validación                │             │
│         └───────────────────────────────────────┘             │
└───────────────────────────────────────────────────────────────┘
```

### Escalado Vertical

```
Planificación de Capacidad de Feature Flags:
┌────────────────────────────────────────┐
│                                        │
│  Escala Pequeña (< 20 flags):          │
│  • Despliegue entorno único            │
│  • Configuración básica                │
│  • Configuraciones entorno mínimas     │
│                                        │
│  Escala Media (20-100 flags):          │
│  • Despliegue multi-entorno            │
│  • Configs específicas por entorno     │
│  • Reglas de targeting avanzadas       │
│                                        │
│  Escala Grande (100+ flags):           │
│  • Múltiples workspaces                │
│  • Jerarquías entorno complejas        │
│  • Patrones gobernanza empresarial     │
│                                        │
└────────────────────────────────────────┘
```

Esta arquitectura proporciona una base sólida para gestionar feature flags a escala mientras mantiene seguridad, rendimiento y mantenibilidad.
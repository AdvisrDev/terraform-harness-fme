# Arquitectura TÃ©cnica - MÃ³dulos de Terraform para Split.io

Este documento proporciona una visiÃ³n tÃ©cnica completa de la arquitectura de mÃ³dulos de Terraform para gestionar feature flags de Split.io e infraestructura de administraciÃ³n en mÃºltiples entornos.

## ğŸ—ï¸ Resumen de Arquitectura del MÃ³dulo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MÃ³dulos de Terraform para Split.io                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   split-feature-flags    â”‚    â”‚    split-administration          â”‚   â”‚
â”‚  â”‚                          â”‚    â”‚                                  â”‚   â”‚
â”‚  â”‚  Variables de Entrada:   â”‚    â”‚  Variables de Entrada:           â”‚   â”‚
â”‚  â”‚  â€¢ workspace_name        â”‚    â”‚  â€¢ environment_name              â”‚   â”‚
â”‚  â”‚  â€¢ environment_name      â”‚    â”‚  â€¢ workspace                     â”‚   â”‚
â”‚  â”‚  â€¢ traffic_type_name     â”‚    â”‚  â€¢ environments                  â”‚   â”‚
â”‚  â”‚  â€¢ feature_flags[]       â”‚    â”‚  â€¢ traffic_types                 â”‚   â”‚
â”‚                             â”‚    â”‚  â€¢ segments                      â”‚   â”‚
â”‚  â”‚  CaracterÃ­sticas:        â”‚    â”‚  â€¢ api_keys[]                    â”‚   â”‚
â”‚  â”‚  â€¢ Filtrado de entornos  â”‚    â”‚  â€¢ environment_segment_keys[]    â”‚   â”‚
â”‚  â”‚  â€¢ FusiÃ³n de config      â”‚    â”‚                                  â”‚   â”‚
â”‚  â”‚  â€¢ ValidaciÃ³n            â”‚    â”‚  CaracterÃ­sticas:                â”‚   â”‚
â”‚  â”‚                          â”‚    â”‚  â€¢ Filtrado de entornos          â”‚   â”‚
â”‚  â”‚  Salida:                 â”‚    â”‚  â€¢ FusiÃ³n de config para keys   â”‚   â”‚
â”‚  â”‚  â€¢ Feature flag splits   â”‚    â”‚                                  â”‚   â”‚
â”‚  â”‚  â€¢ Definiciones split    â”‚    â”‚  Salida:                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â€¢ Recursos infraestructura      â”‚   â”‚
â”‚                                  â”‚  â€¢ API keys, segment keys        â”‚   â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© Componentes Centrales

### 1. MÃ³dulo split-feature-flags

Gestiona definiciones y splits de feature flags con configuraciones especÃ­ficas por entorno.

#### CaracterÃ­sticas Clave
- **Filtrado de Entornos**: Solo despliega flags en entornos especificados
- **FusiÃ³n de Configuraciones**: Fusiona configuraciones base con overrides de entorno
- **ConfiguraciÃ³n Flexible**: Mismos treatments en todos los entornos O diferentes por entorno

#### Estructura de Variables
```hcl
variable "feature_flags" {
  type = list(object({
    name              = string
    description       = string
    default_treatment = string
    environments      = list(string)
    lifecycle_stage   = string
    category          = string
    
    treatments = list(object({
      name           = string
      configurations = string
      description    = string
    }))
    
    rules = list(object({
      treatment = string
      size      = number
      condition = object({
        matcher = object({
          type      = string
          attribute = string
          strings   = list(string)
        })
      })
    }))
    
    # Overrides especÃ­ficos por entorno
    environment_configs = map(object({
      default_treatment = string
      description       = string
      treatments        = list(object({...}))
      rules            = list(object({...}))
    }))
  }))
}
```

### 2. MÃ³dulo split-administration

Gestiona workspace, entornos, tipos de trÃ¡fico, segmentos, API keys y segment keys.

#### CaracterÃ­sticas Clave
- **Filtrado de Entornos**: Filtra API keys y segment keys por entorno
- **FusiÃ³n de Configuraciones**: Fusiona configuraciones base con overrides especÃ­ficos por entorno
- **GestiÃ³n de Infraestructura**: Crea y gestiona infraestructura de Split.io

#### Estructura de Variables
```hcl
variable "api_keys" {
  type = list(object({
    name         = string
    type         = string
    roles        = list(string)
    environments = list(string)
    environment_configs = map(object({
      name  = string
      type  = string
      roles = list(string)
    }))
  }))
}

variable "environment_segment_keys" {
  type = list(object({
    name         = string
    segment_name = string
    keys         = list(string)
    environments = list(string)
    environment_configs = map(object({
      keys = list(string)
    }))
  }))
}
```

## ğŸ”„ PatrÃ³n de Filtrado de Entornos

Ambos mÃ³dulos usan el mismo patrÃ³n de filtrado de entornos:

```hcl
# Filtrar elementos para el entorno actual
environment_items = [
  for item in var.items : item
  if length(item.environments) == 0 || contains(item.environments, var.environment_name)
]

# Fusionar configuraciÃ³n base con overrides de entorno
merged_items = [
  for item in local.environment_items : {
    name = try(item.environment_configs[var.environment_name].name, item.name)
    # ... otras propiedades con fallback try()
  }
]
```

## ğŸ“Š Motor de FusiÃ³n de Configuraciones

### Flujo de LÃ³gica de FusiÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Motor de FusiÃ³n de Configuraciones                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Entrada: items[] + entorno_actual                                      â”‚
â”‚                                     â”‚                                   â”‚
â”‚                                     â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                Para Cada Elemento                               â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  1. Comenzar con configuraciÃ³n base                             â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚     â”‚ Config Base:                                        â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ name: "api-key"                                   â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ type: "server_side"                               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ roles: ["API_FEATURE_FLAG_VIEWER"]                â”‚     â”‚    â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                â”‚                                â”‚    â”‚
â”‚  â”‚                                â–¼                                â”‚    â”‚
â”‚  â”‚  2. Verificar overrides especÃ­ficos por entorno                 â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚     â”‚ environment_configs["prod"]: {                      â”‚     â”‚    â”‚
â”‚  â”‚     â”‚   name: "prd-api-key"                               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚   roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]   â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ }                                                   â”‚     â”‚    â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                â”‚                                â”‚    â”‚
â”‚  â”‚                                â–¼                                â”‚    â”‚
â”‚  â”‚  3. Aplicar lÃ³gica de fusiÃ³n con funciÃ³n try()                  â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚     â”‚ merged_config = {                                   â”‚     â”‚    â”‚
â”‚  â”‚     â”‚   name: try(override.name, base.name)               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚   type: try(override.type, base.type)               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚   roles: try(override.roles, base.roles)            â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ }                                                   â”‚     â”‚    â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                â”‚                                â”‚    â”‚
â”‚  â”‚                                â–¼                                â”‚    â”‚
â”‚  â”‚  4. Resultado: ConfiguraciÃ³n final fusionada                    â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚     â”‚ Config Final:                                       â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ name: "prd-api-key"                               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ type: "server_side"                               â”‚     â”‚    â”‚
â”‚  â”‚     â”‚ â€¢ roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]   â”‚     â”‚    â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                   â”‚
â”‚                                     â–¼                                   â”‚
â”‚  Salida: merged_items[]                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Patrones de ExtensiÃ³n

### 1. Agregar Nuevas Propiedades EspecÃ­ficas por Entorno

```hcl
# En variables.tf
environment_configs = map(object({
  # Propiedades existentes
  name  = optional(string)
  type  = optional(string)
  roles = optional(list(string))
  
  # Nueva propiedad especÃ­fica por entorno
  timeout_seconds = optional(number)
}))

# En main.tf locals
merged_items = [
  for item in local.environment_items : {
    # Fusiones existentes
    name = try(item.environment_configs[var.environment_name].name, item.name)
    
    # Nueva fusiÃ³n de propiedad
    timeout_seconds = try(
      item.environment_configs[var.environment_name].timeout_seconds, 
      item.timeout_seconds
    )
  }
]
```

### 2. Agregar ValidaciÃ³n Personalizada

```hcl
variable "api_keys" {
  # ... definiciÃ³n de tipo
  
  validation {
    condition = alltrue([
      for key in var.api_keys :
      key.type == "admin" ? contains(key.roles, "API_ALL_GRANTED") : true
    ])
    error_message = "API keys admin deben tener el rol API_ALL_GRANTED"
  }
}
```

### 3. Crear Recursos EspecÃ­ficos por Entorno

```hcl
# Filtrar y crear recursos solo para el entorno actual
resource "split_api_key" "this" {
  for_each = local.api_keys_map
  
  workspace_id    = local.workspace_id
  environment_ids = [local.environment_id]
  name            = each.value.name
  type            = each.value.type
  roles           = each.value.roles
}
```

## ğŸ“ˆ Patrones de Uso

### 1. PatrÃ³n de ConfiguraciÃ³n ComÃºn

```hcl
# common.tfvars
api_keys = [
  {
    name = "server"
    type = "server_side"
    roles = ["API_FEATURE_FLAG_VIEWER"]
    environments = ["dev", "staging", "prod"]
    environment_configs = {
      dev = { name = "dev-server" }
      staging = { name = "stg-server" }
      prod = { name = "prd-server" }
    }
  }
]
```

### 2. PatrÃ³n de ConfiguraciÃ³n EspecÃ­fica por Entorno

```hcl
# environments/development.tfvars
environment_name = "dev"

# Elementos solo para desarrollo
api_keys = [
  {
    name = "debug"
    type = "admin"
    roles = ["API_ALL_GRANTED"]
    environments = ["dev"]
  }
]
```

### 3. PatrÃ³n de Consumo de MÃ³dulos

```hcl
# main.tf del caso de uso
module "administration" {
  source = "../../modules/split-administration"
  
  environment_name         = var.environment_name
  workspace                = var.workspace
  environments             = var.environments
  api_keys                 = local.all_api_keys
  environment_segment_keys = local.all_segment_keys
}

locals {
  # Fusionar configuraciones comunes y especÃ­ficas por entorno
  all_api_keys = concat(
    var.common_api_keys != null ? var.common_api_keys : [],
    var.api_keys != null ? var.api_keys : []
  )
}
```

## ğŸ›¡ï¸ Mejores PrÃ¡cticas

### 1. Seguridad de Entornos
- Usar array `environments` para controlar el alcance del despliegue
- Validar nombres de entorno contra valores permitidos
- Usar overrides especÃ­ficos por entorno para configuraciones de seguridad

### 2. GestiÃ³n de ConfiguraciÃ³n
- Definir configuraciones comunes en `common.tfvars`
- Usar archivos especÃ­ficos por entorno solo para elementos Ãºnicos del entorno
- Aprovechar environment_configs para overrides especÃ­ficos por entorno

### 3. Estrategia de ValidaciÃ³n
- Implementar reglas de validaciÃ³n comprehensivas
- Usar validaciones de terraform para feedback inmediato
- Validar referencias cruzadas entre configuraciones

Esta arquitectura proporciona una base sÃ³lida para gestionar infraestructura de Split.io y feature flags a escala mientras mantiene seguridad, rendimiento y mantenibilidad.
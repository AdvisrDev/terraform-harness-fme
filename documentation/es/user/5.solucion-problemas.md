# Gu√≠a de Soluci√≥n de Problemas

Esta gu√≠a te ayuda a resolver problemas comunes al usar el m√≥dulo Terraform de Feature Flags de Split.io.

## üîß Problemas Comunes

### 1. Problemas de Autenticaci√≥n y API

#### Error: No se puede autenticar con la API de Split.io
```
Error: No se puede autenticar con la API de Split.io
```

**Causas:**
- API key inv√°lida
- API key no tiene permisos apropiados
- Problemas de conectividad de red

**Soluciones:**
1. Verificar tu API key:
   ```bash
   # Verificar si API key est√° configurada correctamente
   echo $TF_VAR_split_api_key
   ```

2. Probar conectividad API:
   ```bash
   curl -H "Authorization: Bearer TU_API_KEY" \
        https://api.split.io/internal/api/v2/workspaces
   ```

3. Verificar permisos API key en dashboard Split.io:
   - Navegar a Configuraci√≥n Admin ‚Üí API Keys
   - Asegurar que la clave tiene permisos lectura/escritura
   - Verificar acceso al workspace

#### Error: Workspace no encontrado
```
Error: Workspace 'MiWorkspace' no encontrado
```

**Soluciones:**
1. Verificar ortograf√≠a nombre workspace
2. Verificar que workspace existe en dashboard Split.io
3. Asegurar que API key tiene acceso al workspace

### 2. Problemas de Entorno

#### Error: El entorno ya existe
```
Error: El entorno 'development' ya existe
```

**Esto es comportamiento normal.** Terraform gestionar√° el entorno existente. Para resolver:

1. Importar el entorno existente:
   ```bash
   terraform import split_environment.this workspace_id/environment_id
   ```

2. O dejar que Terraform lo gestione autom√°ticamente (recomendado)

#### Feature flags no aparecen en entorno esperado
**Causas:**
- Nombre de entorno no coincide
- Feature flag no configurado para entorno objetivo
- Filtrado de entorno funcionando seg√∫n dise√±o

**Soluciones:**
1. Verificar que nombre entorno coincide exactamente:
   ```hcl
   # En tu archivo .tfvars
   environment_name = "dev"  # Debe coincidir exactamente
   
   # En configuraci√≥n feature flag
   environments = ["dev", "staging", "prod"]
   ```

2. Verificar que feature flag incluye entorno objetivo:
   ```hcl
   {
     name = "mi-caracteristica"
     environments = ["dev"]  # Agregar "staging", "prod" seg√∫n necesario
   }
   ```

### 3. Problemas Configuraci√≥n Feature Flags

#### Error: Treatment no encontrado
```
Error: Treatment 'xyz' no encontrado en lista treatments
```

**Soluciones:**
1. Asegurar que todos treatments referenciados est√°n definidos:
   ```hcl
   treatments = [
     {
       name = "off"           # ‚úÖ Definido
       configurations = "{}"
     },
     {
       name = "on"            # ‚úÖ Definido
       configurations = "{}"
     }
   ]
   
   default_treatment = "off"  # ‚úÖ Debe existir en treatments
   ```

2. Verificar errores tipogr√°ficos en nombres treatment

#### Error: JSON inv√°lido en configuraciones
```
Error: JSON inv√°lido en configuraciones treatment
```

**Soluciones:**
1. Usar `jsonencode()` para configuraciones complejas:
   ```hcl
   # ‚úÖ Bueno
   configurations = jsonencode({
     timeout = 30
     retries = 3
   })
   
   # ‚ùå Malo - JSON manual propenso a errores
   configurations = "{\"timeout\": 30, \"retries\": 3}"
   ```

2. Validar sintaxis JSON:
   ```bash
   echo '{"timeout": 30}' | jq .
   ```

### 4. Problemas Estado Terraform

#### Error: El recurso ya existe
```
Error: El recurso ya existe
```

**Soluciones:**
1. Importar recursos existentes:
   ```bash
   # Importar workspace
   terraform import split_workspace.this workspace_id
   
   # Importar environment  
   terraform import split_environment.this workspace_id/environment_id
   
   # Importar feature flag
   terraform import split_split.feature_name workspace_id/split_id
   ```

2. Usar `terraform refresh` para sincronizar estado:
   ```bash
   terraform refresh -var="split_api_key=$TF_VAR_split_api_key"
   ```

#### Corrupci√≥n archivo estado o conflictos
**Soluciones:**
1. Hacer backup estado actual:
   ```bash
   cp terraform.tfstate terraform.tfstate.backup
   ```

2. Re-importar recursos si es necesario
3. Usar gesti√≥n estado remoto para entornos de equipo

### 5. Problemas Configuraci√≥n M√≥dulo

#### Error: M√≥dulo no encontrado
```
Error: M√≥dulo no encontrado en ./modules/split-feature-flags
```

**Soluciones:**
1. Verificar que ruta m√≥dulo es correcta:
   ```hcl
   module "feature_flags" {
     source = "./modules/split-feature-flags"  # Verificar ruta
   }
   ```

2. Asegurar que directorio m√≥dulo existe y contiene archivos requeridos

#### Error: Validaci√≥n variable fall√≥
```
Error: Validaci√≥n variable fall√≥
```

**Soluciones:**
1. Verificar restricciones variables:
   ```hcl
   # Ejemplo error validaci√≥n - nombre no puede estar vac√≠o
   {
     name = ""  # ‚ùå Inv√°lido
     name = "mi-caracteristica"  # ‚úÖ V√°lido
   }
   ```

2. Revisar reglas validaci√≥n personalizadas en variables.tf

## üêõ Comandos de Debug

### Debug Terraform

```bash
# Validar sintaxis configuraci√≥n
terraform validate

# Verificar qu√© se crear√°/cambiar√°
terraform plan -var="split_api_key=$TF_VAR_split_api_key"

# Mostrar estado actual
terraform show

# Listar todos recursos en estado
terraform state list

# Mostrar detalles recurso espec√≠fico
terraform state show split_split.feature_name

# Habilitar logging debug
export TF_LOG=DEBUG
terraform apply

# Refrescar estado desde remoto
terraform refresh -var="split_api_key=$TF_VAR_split_api_key"
```

### Debug API Split.io

```bash
# Probar conectividad API
curl -H "Authorization: Bearer $TF_VAR_split_api_key" \
     https://api.split.io/internal/api/v2/workspaces

# Listar entornos en workspace
curl -H "Authorization: Bearer $TF_VAR_split_api_key" \
     https://api.split.io/internal/api/v2/workspaces/WORKSPACE_ID/environments

# Listar feature flags (splits)
curl -H "Authorization: Bearer $TF_VAR_split_api_key" \
     https://api.split.io/internal/api/v2/workspaces/WORKSPACE_ID/splits
```

## üîç Informaci√≥n Diagn√≥stica

### Recopilar Informaci√≥n Debug

Al reportar problemas, incluir:

1. **Versi√≥n Terraform:**
   ```bash
   terraform version
   ```

2. **Versi√≥n provider:**
   ```bash
   terraform providers
   ```

3. **Configuraci√≥n m√≥dulo (sanitizada):**
   ```bash
   # Remover informaci√≥n sensible antes de compartir
   cat main.tf | sed 's/api_key.*/api_key = "REDACTED"/'
   ```

4. **Logs de error:**
   ```bash
   # Con logging debug habilitado
   export TF_LOG=DEBUG
   terraform apply 2>&1 | tee terraform.log
   ```

### Informaci√≥n Entorno

```bash
# Verificar configuraci√≥n entorno
echo "Versi√≥n Terraform: $(terraform version -json | jq -r .terraform_version)"
echo "Directorio trabajo: $(pwd)"
echo "API key configurada: $(if [ -n "$TF_VAR_split_api_key" ]; then echo "S√≠"; else echo "No"; fi)"
echo "Workspace actual: $(terraform workspace show)"
```

## üìã Checklist Resoluci√≥n Problemas

### Antes de Aplicar Cambios
- [ ] Configuraci√≥n Terraform es v√°lida (`terraform validate`)
- [ ] API key est√° configurada y es v√°lida
- [ ] Nombre workspace es correcto
- [ ] Nombre entorno coincide con objetivo
- [ ] Configuraciones feature flag son v√°lidas

### Despu√©s de Encontrar Problemas
- [ ] Verificar mensaje error para causa espec√≠fica
- [ ] Verificar sintaxis configuraci√≥n
- [ ] Probar conectividad API
- [ ] Verificar consistencia estado Terraform
- [ ] Revisar documentaci√≥n m√≥dulo
- [ ] Buscar problemas/documentaci√≥n existentes

### Al Reportar Problemas
- [ ] Incluir configuraci√≥n sanitizada
- [ ] Proporcionar mensaje error completo
- [ ] Incluir versiones Terraform y provider
- [ ] Describir comportamiento esperado vs actual
- [ ] Incluir pasos para reproducir

## üÜò Obtener Ayuda

### Recursos Documentaci√≥n
- [Arquitectura T√©cnica](../technical/1.arquitectura.md)
- [Gu√≠a Primeros Pasos](1.primeros-pasos.md)
- [Mejores Pr√°cticas](3.mejores-practicas.md)
- [Ejemplos](2.ejemplos.md)

### Soporte Comunidad
- GitHub Issues: Reportar bugs y solicitudes caracter√≠sticas
- Documentaci√≥n Split.io: Documentaci√≥n oficial API Split.io
- Documentaci√≥n Provider Terraform: Docs espec√≠ficos provider Split.io

### Soporte Profesional
- Soporte Split.io: Para problemas espec√≠ficos plataforma
- Soporte HashiCorp: Para problemas espec√≠ficos Terraform
- Servicios Profesionales: Para asistencia implementaci√≥n

---

**¬øNecesitas m√°s ayuda?** Revisa la [Gu√≠a Primeros Pasos](1.primeros-pasos.md) o revisa [Ejemplos](2.ejemplos.md) para configuraciones funcionales.
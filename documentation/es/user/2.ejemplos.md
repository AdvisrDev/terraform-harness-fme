# Ejemplos del Módulo Terraform

Este documento contiene ejemplos prácticos extraídos de la carpeta examples, organizados por complejidad y caso de uso.

## 📁 Estructura de Ejemplos

Todos los ejemplos siguen esta estructura:
```
nombre-ejemplo/
├── main.tf          # Configuración del módulo
├── variables.tf     # Variables de entrada
├── outputs.tf       # Valores de salida
├── versions.tf      # Requisitos de provider
└── README.md        # Documentación del ejemplo
```

## 🔰 Ejemplos Básicos

### Feature Flag Simple

Perfecto para aprender los conceptos básicos del módulo.

```hcl
# main.tf
module "simple_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = "development"
  is_production      = false
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "toggle-simple"
      description       = "Un toggle simple on/off de característica"
      default_treatment = "off"
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "Característica deshabilitada"
        },
        {
          name           = "on"
          configurations = "{\"enabled\": true}"
          description    = "Característica habilitada"
        }
      ]
      rules = []
    }
  ]
}

# variables.tf
variable "split_api_key" {
  description = "API key de Split.io"
  type        = string
  sensitive   = true
}

# outputs.tf
output "workspace_id" {
  description = "El ID del workspace de Split.io"
  value       = module.simple_feature_flags.workspace_id
}

output "environment_id" {
  description = "El ID del entorno creado"
  value       = module.simple_feature_flags.environment_id
}

output "feature_flags_summary" {
  description = "Resumen de feature flags creados"
  value       = module.simple_feature_flags.feature_flags_summary
}

# versions.tf
terraform {
  required_version = ">= 1.5"
  required_providers {
    split = {
      source  = "splitsoftware/split"
      version = "~> 1.0"
    }
  }
}
```

**Uso:**
```bash
cd examples/simple-feature-flag
terraform init
terraform plan -var="split_api_key=tu-api-key"
terraform apply -var="split_api_key=tu-api-key"
```

---

## 🎯 Ejemplos Avanzados

### Reglas Targeting Avanzadas

Targeting complejo con múltiples segmentos de usuario.

```hcl
# main.tf
module "advanced_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = "production"
  is_production      = true
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "caracteristicas-premium"
      description       = "Características premium con targeting avanzado"
      default_treatment = "basic"
      treatments = [
        {
          name           = "basic"
          configurations = "{\"tier\": \"basic\", \"features\": [\"feature1\"]}"
          description    = "Características nivel básico"
        },
        {
          name           = "premium"
          configurations = "{\"tier\": \"premium\", \"features\": [\"feature1\", \"feature2\", \"feature3\"]}"
          description    = "Nivel premium con todas las características"
        },
        {
          name           = "enterprise"
          configurations = "{\"tier\": \"enterprise\", \"features\": [\"feature1\", \"feature2\", \"feature3\", \"enterprise_feature\"]}"
          description    = "Nivel enterprise con características avanzadas"
        }
      ]
      rules = [
        {
          treatment = "enterprise"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["enterprise_users"]
            }
          }
        },
        {
          treatment = "premium"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["premium_users"]
            }
          }
        }
      ]
    },
    {
      name              = "experimento-beta"
      description       = "Prueba A/B para nueva característica"
      default_treatment = "control"
      treatments = [
        {
          name           = "control"
          configurations = "{\"variant\": \"control\", \"new_ui\": false}"
          description    = "Grupo control - experiencia existente"
        },
        {
          name           = "treatment_a"
          configurations = "{\"variant\": \"treatment_a\", \"new_ui\": true, \"color_scheme\": \"blue\"}"
          description    = "Tratamiento A - variante UI azul"
        },
        {
          name           = "treatment_b"
          configurations = "{\"variant\": \"treatment_b\", \"new_ui\": true, \"color_scheme\": \"green\"}"
          description    = "Tratamiento B - variante UI verde"
        }
      ]
      rules = [
        {
          treatment = "treatment_a"
          size      = 40
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["beta_testers"]
            }
          }
        },
        {
          treatment = "treatment_b"
          size      = 40
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["beta_testers"]
            }
          }
        }
      ]
    }
  ]
}
```

---

### Configuraciones Específicas por Entorno

Feature flags con diferentes configuraciones por entorno.

```hcl
# main.tf
module "environment_specific_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = var.workspace_name
  environment_name    = var.environment_name
  is_production      = var.is_production
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "limitacion-tasa-api"
      description       = "Limitación tasa API con configs específicas por entorno"
      default_treatment = "standard"
      environments      = ["dev", "staging", "prod"]
      lifecycle_stage   = "production"
      category          = "operational"
      
      # Configuración base
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "Limitación tasa deshabilitada"
        },
        {
          name           = "standard"
          configurations = "{\"enabled\": true, \"requests_per_minute\": 1000}"
          description    = "Limitación tasa estándar"
        }
      ]
      
      rules = []
      
      # Overrides específicos por entorno
      environment_configs = {
        dev = {
          description = "Limitación tasa desarrollo con límites relajados"
          treatments = [
            {
              name           = "off"
              configurations = "{\"enabled\": false, \"debug\": true}"
              description    = "Deshabilitado con logging debug"
            },
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 10000, \"debug\": true}"
              description    = "Límites relajados para desarrollo"
            }
          ]
        }
        
        staging = {
          description = "Limitación tasa staging con monitoreo"
          treatments = [
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 2000, \"monitoring\": true}"
              description    = "Tipo producción con monitoreo"
            }
          ]
        }
        
        prod = {
          description = "Limitación tasa producción con controles estrictos"
          treatments = [
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 1000, \"strict_mode\": true}"
              description    = "Producción con enforcement estricto"
            },
            {
              name           = "restricted"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 500, \"strict_mode\": true}"
              description    = "Modo restringido para alta carga"
            }
          ]
          rules = [
            {
              treatment = "restricted"
              size      = 0  # Solo activación manual
            }
          ]
        }
      }
    }
  ]
}

# example.tfvars
workspace_name   = "Default"
environment_name = "dev"
is_production   = false

# Archivos de entorno
# environments/dev.tfvars
environment_name = "dev"
is_production   = false

# environments/staging.tfvars  
environment_name = "staging"
is_production   = false

# environments/prod.tfvars
environment_name = "prod"
is_production   = true
```

**Uso:**
```bash
# Desplegar a diferentes entornos
terraform apply -var-file="environments/dev.tfvars" -var="split_api_key=tu-key"
terraform apply -var-file="environments/staging.tfvars" -var="split_api_key=tu-key"
terraform apply -var-file="environments/prod.tfvars" -var="split_api_key=tu-key"
```

---

### Gestión Ciclo de Vida Feature Flags

Ejemplo mostrando feature flags en diferentes etapas del ciclo de vida.

```hcl
# main.tf
module "lifecycle_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = var.environment_name
  is_production      = var.is_production
  traffic_type_name  = "user"

  feature_flags = [
    # Característica etapa desarrollo
    {
      name              = "ui-experimental"
      description       = "Componentes UI experimentales"
      default_treatment = "off"
      environments      = ["dev"]  # Solo dev
      lifecycle_stage   = "development"
      category          = "feature"
      
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "UI experimental deshabilitado"
        },
        {
          name           = "on"
          configurations = "{\"enabled\": true, \"debug_mode\": true}"
          description    = "UI experimental habilitado con debug"
        }
      ]
      
      rules = [
        {
          treatment = "on"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_type"
              strings   = ["developer", "designer"]
            }
          }
        }
      ]
    },
    
    # Característica etapa testing
    {
      name              = "optimizacion-pagos"
      description       = "Optimización flujo pagos"
      default_treatment = "original"
      environments      = ["dev", "staging"]  # Dev y staging
      lifecycle_stage   = "testing"
      category          = "experiment"
      
      treatments = [
        {
          name           = "original"
          configurations = "{\"flow_version\": \"v1\"}"
          description    = "Flujo pagos original"
        },
        {
          name           = "optimized"
          configurations = "{\"flow_version\": \"v2\", \"analytics_tracking\": true}"
          description    = "Flujo pagos optimizado con tracking"
        }
      ]
      
      rules = [
        {
          treatment = "optimized"
          size      = 50  # Prueba A/B 50%
        }
      ]
    },
    
    # Característica etapa producción
    {
      name              = "busqueda-avanzada"
      description       = "Funcionalidad búsqueda avanzada"
      default_treatment = "basic"
      environments      = ["dev", "staging", "prod"]  # Todos los entornos
      lifecycle_stage   = "production"
      category          = "feature"
      
      treatments = [
        {
          name           = "basic"
          configurations = "{\"search_type\": \"basic\"}"
          description    = "Funcionalidad búsqueda básica"
        },
        {
          name           = "advanced"
          configurations = "{\"search_type\": \"advanced\", \"ai_suggestions\": true}"
          description    = "Búsqueda avanzada con sugerencias IA"
        }
      ]
      
      environment_configs = {
        dev = {
          rules = [
            {
              treatment = "advanced"
              size      = 100  # Todos los usuarios en dev
            }
          ]
        }
        
        staging = {
          rules = [
            {
              treatment = "advanced"
              size      = 75  # 75% en staging
            }
          ]
        }
        
        prod = {
          rules = [
            {
              treatment = "advanced"
              size      = 25  # Conservador 25% en prod
              condition = {
                matcher = {
                  type      = "IN_SEGMENT"
                  attribute = "user_tier"
                  strings   = ["premium", "enterprise"]
                }
              }
            }
          ]
        }
      }
    },
    
    # Característica deprecada (siendo eliminada gradualmente)
    {
      name              = "dashboard-legacy"
      description       = "Dashboard legacy (siendo deprecado)"
      default_treatment = "new_dashboard"
      environments      = ["prod"]  # Solo prod para migración
      lifecycle_stage   = "deprecated"
      category          = "feature"
      
      treatments = [
        {
          name           = "legacy_dashboard"
          configurations = "{\"dashboard_version\": \"v1\"}"
          description    = "Dashboard legacy (deprecado)"
        },
        {
          name           = "new_dashboard"
          configurations = "{\"dashboard_version\": \"v2\"}"
          description    = "Nuevo dashboard"
        }
      ]
      
      rules = [
        {
          treatment = "legacy_dashboard"
          size      = 5  # Solo 5% aún en legacy
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "migration_status"
              strings   = ["pending_migration"]
            }
          }
        }
      ]
    }
  ]
}
```

---

## 🧪 Ejemplos Testing y Validación

### Testing Feature Flags

```hcl
# test-main.tf
module "test_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Test-Workspace"
  environment_name    = "test"
  is_production      = false
  traffic_type_name  = "user"

  feature_flags = [
    # Test validación feature flag
    {
      name              = "test-validacion"
      description       = "Feature flag para testing reglas validación"
      default_treatment = "control"
      environments      = ["test"]
      lifecycle_stage   = "development"
      category          = "feature"
      
      treatments = [
        {
          name           = "control"
          configurations = "{\"test\": \"control_value\"}"
          description    = "Tratamiento control para testing"
        },
        {
          name           = "test_variant"
          configurations = "{\"test\": \"test_value\", \"additional_config\": true}"
          description    = "Variante test con configuración adicional"
        }
      ]
      
      rules = [
        {
          treatment = "test_variant"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "test_segment"
              strings   = ["test_users"]
            }
          }
        }
      ]
    }
  ]
}

# Outputs de test
output "test_results" {
  description = "Resultados validación test"
  value = {
    workspace_id           = module.test_feature_flags.workspace_id
    environment_id         = module.test_feature_flags.environment_id
    filtered_flags         = module.test_feature_flags.filtered_feature_flags
    merged_flags          = module.test_feature_flags.merged_feature_flags
    feature_flags_summary = module.test_feature_flags.feature_flags_summary
  }
}
```

## 📋 Patrones de Uso

### 1. Flujo Trabajo Desarrollo Local

```bash
# 1. Comenzar con desarrollo
terraform workspace new development
terraform apply -var-file="environments/dev.tfvars" -var="split_api_key=$API_KEY"

# 2. Probar en staging
terraform workspace new staging  
terraform apply -var-file="environments/staging.tfvars" -var="split_api_key=$API_KEY"

# 3. Desplegar a producción
terraform workspace new production
terraform apply -var-file="environments/prod.tfvars" -var="split_api_key=$API_KEY"
```

### 2. Ciclo Vida Feature Flag

```bash
# Crear característica experimental (solo dev)
terraform apply -var-file="dev-experiment.tfvars"

# Promover a testing (dev + staging)
terraform apply -var-file="testing-phase.tfvars"

# Release producción (todos entornos)
terraform apply -var-file="production-release.tfvars"

# Deprecación (remover de no-prod)
terraform apply -var-file="deprecation.tfvars"
```

### 3. Respuesta Emergencia

```bash
# Activar killswitch vía Terraform
terraform apply -var="emergency_mode=true" -target="module.banking_feature_flags.split_split_definition.mantenimiento-sistema"

# O manualmente vía dashboard Split.io
# Navegar al feature flag y cambiar treatment
```

## 🔧 Patrones Avanzados del Módulo

### Configuración Dinámica con Archivos Externos

```hcl
# ejemplo-config-dinamica.tf
locals {
  # Leer configuración feature flags desde archivo JSON externo
  feature_config = jsondecode(file("${path.module}/feature-flags.json"))
  
  # Transformar configuración externa a formato del módulo
  generated_flags = [
    for config in local.feature_config.features : {
      name              = config.name
      description       = config.description
      default_treatment = config.default_treatment
      environments      = config.environments
      lifecycle_stage   = config.lifecycle_stage
      category          = config.category
      treatments        = config.treatments
      rules            = try(config.rules, [])
      environment_configs = try(config.environment_configs, {})
    }
  ]
}

module "dynamic_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = var.workspace_name
  environment_name    = var.environment_name
  is_production      = var.is_production
  traffic_type_name  = "user"

  feature_flags = local.generated_flags
}
```

### Despliegue Condicional de Feature Flags

```hcl
# despliegue-condicional.tf
locals {
  # Solo desplegar características experimentales en no-producción
  experimental_features = var.is_production ? [] : [
    {
      name = "ui-experimental"
      description = "Componentes UI experimentales"
      default_treatment = "off"
      environments = ["dev", "staging"]
      treatments = [
        {
          name = "off"
          configurations = "{\"enabled\": false}"
        },
        {
          name = "on"
          configurations = "{\"enabled\": true}"
        }
      ]
    }
  ]
  
  # Combinar características estables y experimentales
  all_features = concat(var.stable_features, local.experimental_features)
}

module "conditional_flags" {
  source = "../../modules/split-feature-flags"
  
  split_api_key = var.split_api_key
  workspace_name = var.workspace_name
  environment_name = var.environment_name
  is_production = var.is_production
  traffic_type_name = "user"
  
  feature_flags = local.all_features
}
```

Estos ejemplos proporcionan cobertura comprehensiva de diferentes patrones de uso del módulo Terraform, facilitando que los usuarios encuentren el enfoque de configuración correcto para sus necesidades.
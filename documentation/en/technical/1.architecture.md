# Technical Architecture - Feature Management and Experimentation (FME) Terraform Modules

This document provides a comprehensive technical overview of the Terraform module architecture for managing FME feature flags and administration infrastructure across multiple environments.

## üèóÔ∏è Module Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FME Terraform Modules                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   split-feature-flags    ‚îÇ    ‚îÇ    split-administration          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Input Variables:        ‚îÇ    ‚îÇ  Input Variables:                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ workspace_name        ‚îÇ    ‚îÇ  ‚Ä¢ environment_name              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ environment_name      ‚îÇ    ‚îÇ  ‚Ä¢ workspace                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ traffic_type_name     ‚îÇ    ‚îÇ  ‚Ä¢ environments                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ feature_flags[]       ‚îÇ    ‚îÇ  ‚Ä¢ traffic_types                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ  ‚Ä¢ segments                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Core Features:          ‚îÇ    ‚îÇ  ‚Ä¢ api_keys[]                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Environment filtering ‚îÇ    ‚îÇ  ‚Ä¢ environment_segment_keys[]    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Config merging        ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Validation            ‚îÇ    ‚îÇ  Core Features:                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ    ‚îÇ  ‚Ä¢ Environment filtering         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Output:                 ‚îÇ    ‚îÇ  ‚Ä¢ Config merging for keys      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Feature flag splits   ‚îÇ    ‚îÇ                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Split definitions     ‚îÇ    ‚îÇ  Output:                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  ‚Ä¢ Infrastructure resources      ‚îÇ   ‚îÇ
‚îÇ                                  ‚îÇ  ‚Ä¢ API keys, segment keys        ‚îÇ   ‚îÇ
‚îÇ                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üß© Core Components

### 1. split-feature-flags Module

Manages feature flag splits and definitions with environment-specific configurations.

#### Key Features
- **Environment Filtering**: Only deploys flags to specified environments
- **Configuration Merging**: Merges base configs with environment overrides
- **Flexible Configuration**: Same treatments across environments OR different per environment

#### Variable Structure
```hcl
variable "feature_flags" {
  type = list(object({
    name              = string
    description       = string
    default_treatment = string
    environments      = list(string)
    lifecycle_stage   = string
    category          = string
    
    treatments = list(object({
      name           = string
      configurations = string
      description    = string
    }))
    
    rules = list(object({
      treatment = string
      size      = number
      condition = object({
        matcher = object({
          type      = string
          attribute = string
          strings   = list(string)
        })
      })
    }))
    
    # Environment-specific overrides
    environment_configs = map(object({
      default_treatment = string
      description       = string
      treatments        = list(object({...}))
      rules            = list(object({...}))
    }))
  }))
}
```

### 2. split-administration Module

Manages workspace, environments, traffic types, segments, API keys, and segment keys.

#### Key Features
- **Environment Filtering**: Filters API keys and segment keys by environment
- **Configuration Merging**: Merges base configs with environment-specific overrides
- **Infrastructure Management**: Creates and manages Split.io infrastructure

#### Variable Structure
```hcl
variable "api_keys" {
  type = list(object({
    name         = string
    type         = string
    roles        = list(string)
    environments = list(string)
    environment_configs = map(object({
      name  = string
      type  = string
      roles = list(string)
    }))
  }))
}

variable "environment_segment_keys" {
  type = list(object({
    name         = string
    segment_name = string
    keys         = list(string)
    environments = list(string)
    environment_configs = map(object({
      keys = list(string)
    }))
  }))
}
```

## üîÑ Environment Filtering Pattern

Both modules use the same environment filtering pattern:

```hcl
# Filter items for current environment
environment_items = [
  for item in var.items : item
  if length(item.environments) == 0 || contains(item.environments, var.environment_name)
]

# Merge base configuration with environment overrides
merged_items = [
  for item in local.environment_items : {
    name = try(item.environment_configs[var.environment_name].name, item.name)
    # ... other properties with try() fallback
  }
]
```

## üìä Configuration Merging Engine

### Merge Logic Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Configuration Merging Engine                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  Input: items[] + current_environment                                   ‚îÇ
‚îÇ                                     ‚îÇ                                   ‚îÇ
‚îÇ                                     ‚ñº                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                For Each Item                                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  1. Start with base configuration                               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ name: "api-key"                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ type: "server_side"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ roles: ["API_FEATURE_FLAG_VIEWER"]                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  2. Check for environment-specific overrides                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     environment_configs["prod"]: {                              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       name: "prd-api-key"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     }                                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  3. Apply merge logic with try() function                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     merged_config = {                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       name: try(override.name, base.name)                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       type: try(override.type, base.type)                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ       roles: try(override.roles, base.roles)                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     }                                                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  4. Result: Final merged configuration                          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ name: "prd-api-key"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ type: "server_side"                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ roles: ["API_FEATURE_FLAG_VIEWER", "API_AUDIT"]           ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Extension Patterns

### 1. Adding New Environment-Specific Properties

```hcl
# In variables.tf
environment_configs = map(object({
  # Existing properties
  name  = optional(string)
  type  = optional(string)
  roles = optional(list(string))
}))

# In main.tf locals
merged_items = [
  for item in local.environment_items : {
    name = try(item.environment_configs[var.environment_name].name, item.name)
  }
]
```

### 2. Adding Custom Validation

```hcl
variable "api_keys" {
  # ... type definition
  
  validation {
    condition = alltrue([
      for key in var.api_keys :
      key.type == "admin" ? contains(key.roles, "API_ALL_GRANTED") : true
    ])
    error_message = "Admin API keys must have API_ALL_GRANTED role"
  }
}
```

### 3. Creating Environment-Specific Resources

```hcl
# Filter and create resources only for current environment
resource "split_api_key" "this" {
  for_each = local.api_keys_map
  
  workspace_id    = local.workspace_id
  environment_ids = [local.environment_id]
  name            = each.value.name
  type            = each.value.type
  roles           = each.value.roles
}
```

## üìà Usage Patterns

### 1. Common Configuration Pattern

```hcl
# common.tfvars
api_keys = [
  {
    name = "server"
    type = "server_side"
    roles = ["API_FEATURE_FLAG_VIEWER"]
    environments = ["dev", "staging", "prod"]
    environment_configs = {
      dev = { name = "dev-server" }
      staging = { name = "stg-server" }
      prod = { name = "prd-server" }
    }
  }
]
```

### 2. Environment-Specific Configuration Pattern

```hcl
# environments/development.tfvars
environment_name = "dev"

# Development-only items
api_keys = [
  {
    name = "debug"
    type = "admin"
    roles = ["API_ALL_GRANTED"]
    environments = ["dev"]
  }
]
```

### 3. Module Consumption Pattern

```hcl
# Root main.tf - consumes local modules from modules/ folder
module "split_administration" {
  source = "./modules/split-administration"
  count  = length(var.feature_flags) == 0 ? 1 : 0

  environment_name         = var.environment_name
  workspace                = var.workspace
  environments             = var.environments
  traffic_types            = var.traffic_types
  traffic_type_attributes  = var.traffic_type_attributes
  segments                 = var.segments
  environment_segment_keys = var.environment_segment_keys
  api_keys                 = var.api_keys
}

module "feature_flags" {
  source = "./modules/split-feature-flags"
  count  = length(var.feature_flags) > 0 ? 1 : 0

  workspace         = var.workspace
  environment_name  = var.environment_name
  traffic_type_name = var.traffic_type_name
  feature_flags     = var.feature_flags
}

# Use case main.tf - consumes root module
module "administration" {
  source = "../../"
  
  environment_name         = var.environment_name
  workspace                = var.workspace
  environments             = var.environments
  api_keys                 = local.all_api_keys
  environment_segment_keys = local.all_segment_keys
}

locals {
  # Merge common and environment-specific configurations
  all_api_keys = concat(
    var.common_api_keys != null ? var.common_api_keys : [],
    var.api_keys != null ? var.api_keys : []
  )
}
```

## üõ°Ô∏è Best Practices

### 1. Environment Safety
- Use `environments` array to control deployment scope
- Validate environment names against allowed values
- Use environment-specific overrides for security configurations

### 2. Configuration Management
- Define common configurations in `common.tfvars`
- Use environment-specific files only for environment-unique items
- Leverage environment_configs for environment-specific overrides

### 3. Validation Strategy
- Implement comprehensive validation rules
- Use terraform validations for immediate feedback
- Validate cross-references between configurations

This architecture provides a solid foundation for managing Split.io infrastructure and feature flags at scale while maintaining security, performance, and maintainability.
# Technical Architecture - Harness Feature Flag Management and Experimentation (FME)

This document provides a comprehensive technical overview of the Terraform module architecture for managing  FME across multiple environments.

## 🏗️ Module Architecture Overview

```
┌───────────────────────────────────────────────────────────────────────────┐
│                              FME Terraform Module                         │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────┐    ┌─────────────────────────────────────┐   │
│  │     Input Variables     │    │         Core Processing             │   │
│  │                         │    │                                     │   │
│  │  • workspace_name       │    │  ┌─────────────────────────────┐    │   │
│  │  • environment_name     │───▶│  │   Environment Filtering     │    │   │
│  │  • is_production        │    │  └─────────────────────────────┘    │   │
│  │  • traffic_type_name    │    │                 │                   │   │
│  │  • feature_flags[]      │    │                 ▼                   │   │
│  │                         │    │  ┌─────────────────────────────┐    │   │
│  └─────────────────────────┘    │  │ Environment-Specific Config │    │   │
│                                 │  │     Merging Logic           │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 │                 │                   │   │
│                                 │                 ▼                   │   │
│                                 │  ┌─────────────────────────────┐    │   │
│                                 │  │       Validation Engine     │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 │                 │                   │   │
│                                 │                 ▼                   │   │
│                                 │  ┌─────────────────────────────┐    │   │
│                                 │  │      Resource Generation    │    │   │
│                                 │  └─────────────────────────────┘    │   │
│                                 └─────────────────────────────────────┘   │
│                                                 │                         │
│                                                 ▼                         │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │                         Terraform Resources                     │     │
│   │                                                                 │     │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │     │
│   │  │  Workspace  │  │ Environment │  │    Feature Flags        │  │     │
│   │  │   (Data)    │  │ (Resource)  │  │     (Resources)         │  │     │
│   │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │     │
│   │                                                                 │     │
│   │  ┌─────────────┐  ┌─────────────────────────┐                   │     │
│   │  │Traffic Type │  │    Feature Flag         │                   │     │
│   │  │   (Data)    │  │     Definitions         │                   │     │
│   │  │             │  │     (Resources)         │                   │     │
│   │  └─────────────┘  └─────────────────────────┘                   │     │
│   └─────────────────────────────────────────────────────────────────┘     │
│                                                  │                        │
│                                                  ▼                        │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │                      Outputs                                    │     │
│   │                                                                 │     │
│   │  • workspace_id              • filtered_feature_flags           │     │
│   │  • environment_id            • merged_feature_flags             │     │
│   │  • feature_flags_summary     • environment_specific_configs     │     │
│   └─────────────────────────────────────────────────────────────────┘     │
└───────────────────────────────────────────────────────────────────────────┘
```

## 🧩 Core Components

### 1. Input Processing Layer

#### Variable Structure
The module accepts a complex variable structure that supports both base configurations and environment-specific overrides:

```hcl
variable "feature_flags" {
  type = list(object({
    # Core attributes
    name              = string
    description       = string
    default_treatment = string
    environments      = optional(list(string), ["dev", "staging", "prod"])
    lifecycle_stage   = optional(string, "development")
    category          = optional(string, "feature")
    
    # Base configuration
    treatments = list(object({
      name           = string
      configurations = optional(string, "{}")
      description    = optional(string, "")
    }))
    
    rules = optional(list(object({
      treatment = optional(string)
      size      = optional(number, 100)
      condition = optional(object({
        matcher = object({
          type      = string
          attribute = string
          strings   = optional(list(string), [])
        })
      }))
    })), [])
    
    # Environment-specific overrides
    environment_configs = optional(map(object({
      default_treatment = optional(string)
      description       = optional(string)
      treatments        = optional(list(object({...})))
      rules            = optional(list(object({...})))
    })), {})
  }))
}
```

#### Validation Engine
```
┌─────────────────────────────────────────────────────┐
│                Validation Engine                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────┐  ┌─────────────────────────┐  │
│  │ Basic Validation │  │ Environment Validation  │  │
│  │                  │  │                         │  │
│  │ • Name not empty │  │ • Valid environments    │  │
│  │ • Description    │  │ • Config consistency    │  │
│  │ • Treatments≥2   │  │ • Reference integrity   │  │
│  │ • Default exists │  │ • Rule size limits      │  │
│  └──────────────────┘  └─────────────────────────┘  │
│           │                        │                │
│           └────────────┬───────────┘                │
│                        │                            │
│                        ▼                            │
│  ┌─────────────────────────────────────────────┐    │
│  │        Advanced Validation                  │    │
│  │                                             │    │
│  │ • Lifecycle stage validity                  │    │
│  │ • Category classification                   │    │
│  │ • Treatment name uniqueness                 │    │
│  │ • Rule percentage validation                │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
```

### 2. Environment Filtering Engine

The environment filtering engine determines which feature flags should be deployed to the current environment:

```
┌─────────────────────────────────────────────────────────────────┐
│                  Environment Filtering Engine                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Input: feature_flags[] + current_environment                   │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Environment Check                          │    │
│  │                                                         │    │
│  │  for each feature_flag:                                 │    │
│  │    if current_environment in flag.environments:         │    │
│  │      √ Include in deployment                            │    │
│  │    else:                                                │    │
│  │      x Skip (safety filter)                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                │                                │
│                                ▼                                │
│  Output: environment_feature_flags[]                            │
│                                                                 │
│  Example:                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Flag A: environments = ["dev", "staging", "prod"]       │    │
│  │ Flag B: environments = ["dev", "staging"]               │    │
│  │ Flag C: environments = ["dev"]                          │    │
│  │                                                         │    │
│  │ Current Environment: "prod"                             │    │
│  │ Result: [Flag A] √                                      │    │
│  │         Flag B x (not in prod)                          │    │
│  │         Flag C x (not in prod)                          │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Configuration Merging Engine

The most sophisticated component handles merging base configurations with environment-specific overrides:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Configuration Merging Engine                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Input: filtered_feature_flags[] + current_environment                  │
│                                     │                                   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    For Each Feature Flag                        │    │
│  │                                                                 │    │
│  │  1. Start with base configuration                               │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ Base Config:                                        │     │    │
│  │     │ • name: "api-limiting"                              │     │    │
│  │     │ • description: "API rate limiting"                  │     │    │
│  │     │ • default_treatment: "standard"                     │     │    │
│  │     │ • treatments: [standard, off]                       │     │    │
│  │     │ • rules: []                                         │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  2. Check for environment-specific overrides                    │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ environment_configs["prod"]: {                      │     │    │
│  │     │   description: "Prod API limiting with security"    │     │    │
│  │     │   treatments: [enhanced_standard, off]              │     │    │
│  │     │   rules: [premium_user_rule]                        │     │    │
│  │     │ }                                                   │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  3. Apply merge logic with try() function                       │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ merged_config = {                                   │     │    │
│  │     │   name: base.name                                   │     │    │
│  │     │   description: try(override.description,            │     │    │
│  │     │                     base.description)               │     │    │
│  │     │   treatments: try(override.treatments,              │     │    │
│  │     │                   base.treatments)                  │     │    │
│  │     │   rules: try(override.rules, base.rules)            │     │    │
│  │     │ }                                                   │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  │                                │                                │    │
│  │                                ▼                                │    │
│  │  4. Result: Final merged configuration                          │    │
│  │     ┌─────────────────────────────────────────────────────┐     │    │
│  │     │ Final Config:                                       │     │    │
│  │     │ • name: "api-limiting"                              │     │    │
│  │     │ • description: "Prod API limiting with security"    │     │    │
│  │     │ • treatments: [enhanced_standard, off]              │     │    │
│  │     │ • rules: [premium_user_rule]                        │     │    │
│  │     └─────────────────────────────────────────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                     │                                   │
│                                     ▼                                   │
│  Output: merged_feature_flags[]                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Data Flow Architecture

### Processing resources workflow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Input     │    │ Environment │    │Configuration│    │  Resource   │
│ Variables   │───▶│  Filtering  │───▶│   Merging   │───▶│ Generation  │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│feature_flags│    │environment_ │    │  merged_    │    │split_split  │
│     []      │    │feature_flags│    │feature_flags│    │split_split_ │
│             │    │     []      │    │     []      │    │definition   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                 │
                                                                 ▼
                                                         ┌─────────────┐
                                                         │   Outputs   │
                                                         │             │
                                                         └─────────────┘
```

### Local Variables Flow

```hcl
locals {
  # 1. Environment filtering
  environment_feature_flags = [
    for ff in var.feature_flags : ff
    if contains(ff.environments, var.environment_name)
  ]
  
  # 2. Configuration merging
  merged_feature_flags = [
    for ff in local.environment_feature_flags : {
      name = ff.name
      description = try(
        ff.environment_configs[var.environment_name].description,
        ff.description
      )
      default_treatment = try(
        ff.environment_configs[var.environment_name].default_treatment,
        ff.default_treatment
      )
      treatments = try(
        ff.environment_configs[var.environment_name].treatments,
        ff.treatments
      )
      rules = try(
        ff.environment_configs[var.environment_name].rules,
        ff.rules
      )
      # Metadata for tracking
      _original_config = ff
      _environment_config = try(
        ff.environment_configs[var.environment_name],
        null
      )
    }
  ]
  
  # 3. Resource mapping
  feature_flags_map = {
    for ff in local.merged_feature_flags : ff.name => ff
  }
}
```

## 🛡️ Security Architecture

### Input Validation

```
┌────────────────────────────────────────────────────────────────────────┐
│                         Security Validation Layer                      │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Input Sanitization                           │   │
│  │                                                                 │   │
│  │  • All string inputs validated for length                       │   │
│  │  • No empty names or descriptions allowed                       │   │
│  │  • Treatment names must be unique within flag                   │   │
│  │  • Default treatment must exist in treatments list              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                Environment Security                             │   │
│  │                                                                 │   │
│  │  • Environment configs only reference allowed environments      │   │
│  │  • Production flag set correctly                                │   │
│  │  • Environment names validated against allowed list             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 Business Logic Validation                       │   │
│  │                                                                 │   │
│  │  • Lifecycle stages must be valid values                        │   │
│  │  • Categories must be from approved list                        │   │
│  │  • Rule percentages between 0-100                               │   │
│  │  • Configuration JSON structure validation                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

### Environment Isolation

```
Dev Environment          Staging Environment       Production Environment
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│ • Debug flags   │      │ • Test flags    │      │ • Prod flags    │
│ • High limits   │ ───▶ │ • Monitoring    │ ───▶ │ • Security      │
│ • Mock data     │      │ • Analytics     │      │ • Audit logs    │
│ • Experimental  │      │ • A/B testing   │      │ • Conservative  │
│                 │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
        ▲                         ▲                         ▲
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
                    ┌──────────────────────────┐
                    │   Safety Filter Engine   │
                    │                          │
                    │ • Environment checks     │
                    │ • Configuration merging  │
                    │ • Feature Access control │
                    └──────────────────────────┘
```

## 📊 Performance Considerations

### Resource Creation Strategy

The module uses Terraform's `for_each` meta-argument for efficient resource management:

```hcl
# Efficient resource creation
resource "split_split" "this" {
  for_each = local.feature_flags_map  # O(n) operation
  # ... resource configuration
}

# Instead of multiple individual resources which would be O(n²)
```

## 🔧 Extension Points

### Custom Validation

The module provides extension points for custom validation:

```hcl
# Custom validation example
variable "feature_flags" {
  validation {
    condition = alltrue([
      for ff in var.feature_flags :
      # Custom business rule validation
      ff.category == "killswitch" ? ff.default_treatment == "off" : true
    ])
    error_message = "Killswitch flags must default to 'off'"
  }
}
```

## 📈 Scalability Architecture

### Horizontal Scaling

```
Multi-Workspace Architecture:
┌───────────────────────────────────────────────────────────────┐
│                                                               │
│  Workspace A        Workspace B        Workspace C            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ Product A   │    │ Product B   │    │ Product C   │        │
│  │ Flags       │    │ Flags       │    │ Flags       │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│         │                   │                   │             │
│         └───────────────────┼───────────────────┘             │
│                             │                                 │
│         ┌───────────────────────────────────────┐             │
│         │        Shared Module Core             │             │
│         │                                       │             │
│         │  • Environment filtering              │             │
│         │  • Configuration merging              │             │
│         │  • Validation engine                  │             │
│         └───────────────────────────────────────┘             │
└───────────────────────────────────────────────────────────────┘
```

### Vertical Scaling

```
Feature Flag Capacity Planning:
┌────────────────────────────────────────┐
│                                        │
│  Small Scale (< 20 flags):             │
│  • Single environment deployment       │
│  • Basic configuration                 │
│  • Minimal environment overrides       │
│                                        │
│  Medium Scale (20-100 flags):          │
│  • Multi-environment deployment        │
│  • Environment-specific configs        │
│  • Advanced targeting rules            │
│                                        │
│  Large Scale (100+ flags):             │
│  • Multiple workspaces                 │
│  • Complex environment hierarchies     │
│  • Enterprise governance patterns      │
│                                        │
└────────────────────────────────────────┘
```


This architecture provides a solid foundation for managing feature flags at scale while maintaining security, performance, and maintainability.
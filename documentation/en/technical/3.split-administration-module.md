# Split Administration Module Technical Documentation

## 🎯 Overview

The Split Administration module provides comprehensive management for Split.io resources. It handles the foundational setup required before deploying feature flags, including workspace management, environment configuration, traffic type definitions, segment management, and API key provisioning.

## 🏗️ Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Split Administration Module Architecture             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Resource Management                         │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Workspace   │  │ Environment │  │ Traffic Type        │    │   │
│  │  │ Management  │  │ Management  │  │ Management          │    │   │
│  │  │             │  │             │  │                     │    │   │
│  │  │• Create/    |  |             |  |                     |    |   |
|  |  |   Reference │  │• Multi-env  │  │• Type Definition    │    │   │
│  │  │• Tagging    │  │• Production │  │• Attribute Config   │    │   │
│  │  │• Lifecycle  │  │  Controls   │  │• Data Validation    │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Access & Security Management                 │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Segment     │  │ Environment │  │ API Key             │    │   │
│  │  │ Management  │  │ Segment     │  │ Management          │    │   │
│  │  │             │  │ Keys        │  │                     │    │   │
│  │  │• Definition │  │• Key Assign │  │• Role-based Access  │    │   │
│  │  │• Targeting  │  │• Environment│  │• Environment Scope  │    │   │
│  │  │• Validation │  │  Isolation  │  │• Security Controls  │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Integration Layer                           │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │   │
│  │  │ Output      │  │ Dependency  │  │ Validation &        │    │   │
│  │  │ Structure   │  │ Management  │  │ Error Handling      │    │   │
│  │  │             │  │             │  │                     │    │   │
│  │  │• Structured │  │• Resource   │  │• Input Validation   │    │   │
│  │  │  Data       │  │  Ordering   │  │• Dependency Checks  │    │   │
│  │  │• References │  │• State Mgmt │  │• Error Recovery     │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔧 Core Components

### 1. Workspace Management

The workspace component provides centralized management of Split.io workspaces with support for both creation and reference operations.

#### Key Features
- **Conditional Creation**: Create new workspaces or reference existing ones
- **Tagging Support**: Apply metadata tags for organization and governance
- **Lifecycle Management**: Handle workspace state transitions

#### Resource Configuration
```hcl
resource "split_workspace" "this" {
  count = var.create_workspace ? 1 : 0
  name  = var.workspace_name
  
  dynamic "tags" {
    for_each = var.workspace_tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}

data "split_workspace" "this" {
  count = var.create_workspace ? 0 : 1
  name  = var.workspace_name
}

locals {
  workspace_id = var.create_workspace ? split_workspace.this[0].id : data.split_workspace.this[0].id
}
```

#### Design Patterns
- **Conditional Resource Creation**: Uses count parameter to create or reference
- **Local Value Resolution**: Centralizes workspace ID resolution logic
- **Tag Propagation**: Supports dynamic tag assignment

### 2. Environment Management

Multi-environment support with production safety controls and comprehensive configuration options.

#### Key Features
- **Multi-Environment Support**: Configure multiple environments simultaneously
- **Production Controls**: Special handling for production environments
- **Environment Isolation**: Separate configuration per environment
- **Tag Management**: Environment-specific metadata

#### Resource Configuration
```hcl
resource "split_environment" "this" {
  for_each = var.environments
  
  workspace_id = local.workspace_id
  name         = each.value.name
  production   = each.value.production
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

### 3. Traffic Type Management

Defines and manages traffic types with support for custom attributes and validation.

#### Key Features
- **Type Definition**: Define user, account, or custom traffic types
- **Display Names**: Human-readable names for UI presentation
- **Attribute Support**: Custom attributes with data type validation
- **Searchability Controls**: Configure which attributes are searchable

#### Resource Configuration
```hcl
resource "split_traffic_type" "this" {
  for_each = var.traffic_types
  
  workspace_id    = local.workspace_id
  name            = each.value.name
  display_name    = each.value.display_name
}

resource "split_traffic_type_attribute" "this" {
  for_each = var.traffic_type_attributes
  
  workspace_id    = local.workspace_id
  traffic_type_id = split_traffic_type.this[each.value.traffic_type_key].id
  id              = each.value.id
  display_name    = each.value.display_name
  description     = each.value.description
  data_type       = each.value.data_type
  is_searchable   = each.value.is_searchable
  suggested_values = each.value.suggested_values
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

### 4. Segment Management

Provides user segmentation capabilities with targeting and validation features.

#### Key Features
- **Segment Definition**: Create named user segments
- **Traffic Type Association**: Link segments to specific traffic types
- **Description Support**: Document segment purpose and criteria
- **Tag Management**: Organize segments with metadata

#### Resource Configuration
```hcl
resource "split_segment" "this" {
  for_each = var.segments
  
  workspace_id    = local.workspace_id
  traffic_type_id = split_traffic_type.this[each.value.traffic_type_key].id
  name            = each.value.name
  description     = each.value.description
  
  dynamic "tags" {
    for_each = each.value.tags
    content {
      key   = tags.key
      value = tags.value
    }
  }
}
```

#### Segment Design Patterns
```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Segment Architecture Patterns                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Business Segments:                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Premium Users        • Geographic Regions                     │   │
│  │ • Beta Testers         • Customer Tiers                         │   │
│  │ • Internal Users       • Subscription Types                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Technical Segments:                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Device Types         • Application Versions                   │   │
│  │ • Browser Capabilities • Performance Tiers                      │   │
│  │ • Network Conditions   • Feature Compatibility                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Operational Segments:                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • Load Testing         • Canary Deployments                     │   │
│  │ • Error Recovery       • Maintenance Windows                    │   │
│  │ • Capacity Management  • Emergency Response                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5. Environment Segment Keys

Manages the assignment of specific keys to segments within environments.

#### Key Features
- **Environment Isolation**: Separate key sets per environment
- **Dynamic Key Management**: Add/remove keys as needed
- **Bulk Operations**: Manage multiple keys efficiently
- **Validation**: Ensure key consistency and format

#### Resource Configuration
```hcl
resource "split_environment_segment_keys" "this" {
  for_each = var.environment_segment_keys
  
  workspace_id   = local.workspace_id
  environment_id = split_environment.this[each.value.environment_key].id
  segment_name   = each.value.segment_name
  keys           = each.value.keys
}
```

### 6. API Key Management

Secure management of API keys with role-based access control.

#### Key Features
- **Role-Based Access**: Assign specific roles to API keys
- **Environment Scoping**: Keys are scoped to specific environments
- **Type Management**: Support for server and client key types

#### Resource Configuration
```hcl
resource "split_api_key" "this" {
  for_each = var.api_keys
  
  workspace_id   = local.workspace_id
  environment_id = split_environment.this[each.value.environment_key].id
  name           = each.value.name
  type           = each.value.type
  roles          = each.value.roles
}
```

## 🔄 Data Flow and Dependencies

### Resource Creation Order
```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Resource Creation Flow                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. Workspace ──┐                                                       │
│                 │                                                       │
│                 ▼                                                       │
│  2. Environments ──┐                                                    │
│                    │                                                    │
│                    ▼                                                    │
│  3. Traffic Types ──┐                                                   │
│                     │                                                   │
│                     ▼                                                   │
│  4. Traffic Type Attributes ──┐                                         │
│                               │                                         │
│                               ▼                                         │
│  5. Segments ──┐                                                        │
│                │                                                        │
│                ▼                                                        │
│  6. Environment Segment Keys ──┐                                        │
│                                │                                        │
│                                ▼                                        │
│  7. API Keys                                                            │
│                                                                         │
│  Dependencies:                                                          │
│  • Each resource depends on workspace_id                               │
│  • Environments provide environment_id for subsequent resources        │
│  • Traffic types provide traffic_type_id for attributes and segments   │
│  • Segments provide segment context for environment segment keys       │
└─────────────────────────────────────────────────────────────────────────┘
```

### Integration Testing
```bash
echo "Starting Split Administration Integration Tests..."

# Test 1: Module initialization
echo "Test 1: Module Initialization"
terraform init -upgrade
terraform validate

# Test 2: Plan generation
echo "Test 2: Plan Generation"
terraform plan -var-file="test.tfvars" -out=test.plan

# Test 3: Resource creation
echo "Test 3: Resource Creation"
terraform apply -auto-approve test.plan

# Test 4: State validation
echo "Test 4: State Validation"
terraform show -json | jq '.values.root_module.resources[] | select(.type == "split_workspace")'

# Test 5: Output validation
echo "Test 5: Output Validation"
WORKSPACE_ID=$(terraform output -raw workspace_id)
if [ -z "$WORKSPACE_ID" ]; then
  echo "ERROR: Workspace ID not found in outputs"
  exit 1
fi

# Test 6: Clean up
echo "Test 6: Clean Up"
terraform destroy -auto-approve -var-file="test.tfvars"

echo "All tests passed successfully!"
```

This comprehensive technical documentation provides deep insights into the Split Administration module's architecture, components, and operational aspects. The module is designed for enterprise-scale deployments with security, performance, and maintainability as primary concerns.
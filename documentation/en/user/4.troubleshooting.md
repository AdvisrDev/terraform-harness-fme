# Troubleshooting Guide

This guide helps you resolve common issues when using the Split.io Feature Flag Terraform module.

## 🔧 Common Issues

### 1. Authentication & API Issues

#### Error: Unable to authenticate with Split.io API
```
Error: Unable to authenticate with the Split.io API
```

**Causes:**
- Invalid API key
- API key doesn't have proper permissions
- Network connectivity issues

**Solutions:**
1. Verify your API key:
   ```bash
   # Check if API key is set correctly
   echo $TF_VAR_split_api_key
   ```

2. Test API connectivity:
   ```bash
   curl -H "Authorization: Bearer YOUR_API_KEY" \
        https://api.split.io/internal/api/v2/workspaces
   ```

3. Check API key permissions in Split.io dashboard:
   - Navigate to Admin Settings → API Keys
   - Ensure key has read/write permissions
   - Verify workspace access

#### Error: Workspace not found
```
Error: Workspace 'MyWorkspace' not found
```

**Solutions:**
1. Check workspace name spelling
2. Verify workspace exists in Split.io dashboard
3. Ensure API key has access to the workspace

### 2. Environment Issues

#### Error: Environment already exists
```
Error: Environment 'development' already exists
```

**This is normal behavior.** Terraform will manage the existing environment. To resolve:

1. Import the existing environment:
   ```bash
   terraform import split_environment.this workspace_id/environment_id
   ```

2. Or let Terraform manage it automatically (recommended)

#### Feature flags not appearing in expected environment
**Causes:**
- Environment name mismatch
- Feature flag not configured for target environment
- Environment filtering working as designed

**Solutions:**
1. Check environment name matches exactly:
   ```hcl
   # In your .tfvars file
   environment_name = "dev"  # Must match exactly
   
   # In feature flag configuration
   environments = ["dev", "staging", "prod"]
   ```

2. Verify feature flag includes target environment:
   ```hcl
   {
     name = "my-feature"
     environments = ["dev"]  # Add "staging", "prod" as needed
   }
   ```

### 3. Feature Flag Configuration Issues

#### Error: Treatment not found
```
Error: Treatment 'xyz' not found in treatments list
```

**Solutions:**
1. Ensure all referenced treatments are defined:
   ```hcl
   treatments = [
     {
       name = "off"           # ✅ Defined
       configurations = "{}"
     },
     {
       name = "on"            # ✅ Defined
       configurations = "{}"
     }
   ]
   
   default_treatment = "off"  # ✅ Must exist in treatments
   ```

2. Check for typos in treatment names

#### Error: Invalid JSON in configurations
```
Error: Invalid JSON in treatment configurations
```

**Solutions:**
1. Use `jsonencode()` for complex configurations:
   ```hcl
   # ✅ Good
   configurations = jsonencode({
     timeout = 30
     retries = 3
   })
   
   # ❌ Bad - manual JSON prone to errors
   configurations = "{\"timeout\": 30, \"retries\": 3}"
   ```

2. Validate JSON syntax:
   ```bash
   echo '{"timeout": 30}' | jq .
   ```

### 4. Terraform State Issues

#### Error: Resource already exists
```
Error: Resource already exists
```

**Solutions:**
1. Import existing resources:
   ```bash
   # Import workspace
   terraform import split_workspace.this workspace_id
   
   # Import environment  
   terraform import split_environment.this workspace_id/environment_id
   
   # Import feature flag
   terraform import split_split.feature_name workspace_id/split_id
   ```

2. Use `terraform refresh` to sync state:
   ```bash
   terraform refresh -var="split_api_key=$TF_VAR_split_api_key"
   ```

#### State file corruption or conflicts
**Solutions:**
1. Backup current state:
   ```bash
   cp terraform.tfstate terraform.tfstate.backup
   ```

2. Re-import resources if needed
3. Use remote state management for team environments

### 5. Module Configuration Issues

#### Error: Module not found
```
Error: Module not found at ./modules/split-feature-flags
```

**Solutions:**
1. Check module path is correct:
   ```hcl
   module "feature_flags" {
     source = "./modules/split-feature-flags"  # Verify path
   }
   ```

2. Ensure module directory exists and contains required files

#### Error: Variable validation failed
```
Error: Variable validation failed
```

**Solutions:**
1. Check variable constraints:
   ```hcl
   # Example validation error - name cannot be empty
   {
     name = ""  # ❌ Invalid
     name = "my-feature"  # ✅ Valid
   }
   ```

2. Review custom validation rules in variables.tf

## 🐛 Debugging Commands

### Terraform Debugging

```bash
# Validate configuration syntax
terraform validate

# Check what will be created/changed
terraform plan -var="split_api_key=$TF_VAR_split_api_key"

# Show current state
terraform show

# List all resources in state
terraform state list

# Show details of specific resource
terraform state show split_split.feature_name

# Enable debug logging
export TF_LOG=DEBUG
terraform apply

# Refresh state from remote
terraform refresh -var="split_api_key=$TF_VAR_split_api_key"
```

### Module Configuration Debugging

```bash
# Debug module source and version
terraform get -update

# Check module variables
terraform console
> var.feature_flags
> local.merged_feature_flags

# Validate module configuration
terraform validate

# Debug specific resources
terraform plan -target=module.feature_flags.split_split.specific_flag
```

## 🔍 Diagnostic Information

### Gathering Debug Information

When reporting issues, include:

1. **Terraform version:**
   ```bash
   terraform version
   ```

2. **Provider version:**
   ```bash
   terraform providers
   ```

3. **Module configuration (sanitized):**
   ```bash
   # Remove sensitive information before sharing
   cat main.tf | sed 's/api_key.*/api_key = "REDACTED"/'
   ```

4. **Error logs:**
   ```bash
   # With debug logging enabled
   export TF_LOG=DEBUG
   terraform apply 2>&1 | tee terraform.log
   ```

### Environment Information

```bash
# Check environment setup
echo "Terraform version: $(terraform version -json | jq -r .terraform_version)"
echo "Working directory: $(pwd)"
echo "API key set: $(if [ -n "$TF_VAR_split_api_key" ]; then echo "Yes"; else echo "No"; fi)"
echo "Current workspace: $(terraform workspace show)"
```

## 📋 Issue Resolution Checklist

### Before Applying Changes
- [ ] Terraform configuration is valid (`terraform validate`)
- [ ] API key is set and valid
- [ ] Workspace name is correct
- [ ] Environment name matches target
- [ ] Feature flag configurations are valid

### After Encountering Issues
- [ ] Check error message for specific cause
- [ ] Verify configuration syntax
- [ ] Test API connectivity
- [ ] Check Terraform state consistency
- [ ] Review module documentation
- [ ] Search existing issues/documentation

### When Reporting Issues
- [ ] Include sanitized configuration
- [ ] Provide complete error message
- [ ] Include Terraform and provider versions
- [ ] Describe expected vs actual behavior
- [ ] Include steps to reproduce

## 🆘 Getting Help

### Documentation Resources
- [Technical Architecture](../technical/1.architecture.md)
- [Getting Started Guide](1.getting-started.md)
- [Best Practices](3.best-practices.md)
- [Examples](2.examples.md)

### Professional Support
- Harness Support: For platform-specific issues
- Professional Services: For implementation assistance

---

**Need more help?** Check the [Getting Started Guide](1.getting-started.md) or review [Examples](2.examples.md) for working configurations.
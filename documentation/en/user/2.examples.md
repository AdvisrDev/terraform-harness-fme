# Terraform Module Examples

This document contains practical examples extracted from the examples folder, organized by complexity and use case.

## ðŸ“ Example Structure

All examples follow this structure:
```
example-name/
â”œâ”€â”€ main.tf          # Module configuration
â”œâ”€â”€ variables.tf     # Input variables
â”œâ”€â”€ outputs.tf       # Output values
â”œâ”€â”€ versions.tf      # Provider requirements
â””â”€â”€ README.md        # Example documentation
```

## ðŸ”° Basic Examples

### Simple Feature Flag

Perfect for learning the basics of the module.

```hcl
# main.tf
module "simple_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = "development"
  is_production      = false
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "simple-toggle"
      description       = "A simple on/off feature toggle"
      default_treatment = "off"
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "Feature is disabled"
        },
        {
          name           = "on"
          configurations = "{\"enabled\": true}"
          description    = "Feature is enabled"
        }
      ]
      rules = []
    }
  ]
}

# variables.tf
variable "split_api_key" {
  description = "Split.io API key"
  type        = string
  sensitive   = true
}

# outputs.tf
output "workspace_id" {
  description = "The ID of the Split.io workspace"
  value       = module.simple_feature_flags.workspace_id
}

output "environment_id" {
  description = "The ID of the created environment"
  value       = module.simple_feature_flags.environment_id
}

output "feature_flags_summary" {
  description = "Summary of created feature flags"
  value       = module.simple_feature_flags.feature_flags_summary
}

# versions.tf
terraform {
  required_version = ">= 1.5"
  required_providers {
    split = {
      source  = "splitsoftware/split"
      version = "~> 1.0"
    }
  }
}
```

**Usage:**
```bash
cd examples/simple-feature-flag
terraform init
terraform plan -var="split_api_key=your-api-key"
terraform apply -var="split_api_key=your-api-key"
```

---

## ðŸŽ¯ Advanced Examples

### Advanced Targeting Rules

Complex targeting with multiple user segments.

```hcl
# main.tf
module "advanced_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = "production"
  is_production      = true
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "premium-features"
      description       = "Premium features with advanced targeting"
      default_treatment = "basic"
      treatments = [
        {
          name           = "basic"
          configurations = "{\"tier\": \"basic\", \"features\": [\"feature1\"]}"
          description    = "Basic tier features"
        },
        {
          name           = "premium"
          configurations = "{\"tier\": \"premium\", \"features\": [\"feature1\", \"feature2\", \"feature3\"]}"
          description    = "Premium tier with all features"
        },
        {
          name           = "enterprise"
          configurations = "{\"tier\": \"enterprise\", \"features\": [\"feature1\", \"feature2\", \"feature3\", \"enterprise_feature\"]}"
          description    = "Enterprise tier with advanced features"
        }
      ]
      rules = [
        {
          treatment = "enterprise"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["enterprise_users"]
            }
          }
        },
        {
          treatment = "premium"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["premium_users"]
            }
          }
        }
      ]
    },
    {
      name              = "beta-experiment"
      description       = "A/B test for new feature"
      default_treatment = "control"
      treatments = [
        {
          name           = "control"
          configurations = "{\"variant\": \"control\", \"new_ui\": false}"
          description    = "Control group - existing experience"
        },
        {
          name           = "treatment_a"
          configurations = "{\"variant\": \"treatment_a\", \"new_ui\": true, \"color_scheme\": \"blue\"}"
          description    = "Treatment A - blue UI variant"
        },
        {
          name           = "treatment_b"
          configurations = "{\"variant\": \"treatment_b\", \"new_ui\": true, \"color_scheme\": \"green\"}"
          description    = "Treatment B - green UI variant"
        }
      ]
      rules = [
        {
          treatment = "treatment_a"
          size      = 40
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["beta_testers"]
            }
          }
        },
        {
          treatment = "treatment_b"
          size      = 40
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_segment"
              strings   = ["beta_testers"]
            }
          }
        }
      ]
    }
  ]
}
```

---

### Environment-Specific Configurations

Feature flags with different configurations per environment.

```hcl
# main.tf
module "environment_specific_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = var.workspace_name
  environment_name    = var.environment_name
  is_production      = var.is_production
  traffic_type_name  = "user"

  feature_flags = [
    {
      name              = "api-rate-limiting"
      description       = "API rate limiting with environment-specific configs"
      default_treatment = "standard"
      environments      = ["dev", "staging", "prod"]
      lifecycle_stage   = "production"
      category          = "operational"
      
      # Base configuration
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "Rate limiting disabled"
        },
        {
          name           = "standard"
          configurations = "{\"enabled\": true, \"requests_per_minute\": 1000}"
          description    = "Standard rate limiting"
        }
      ]
      
      rules = []
      
      # Environment-specific overrides
      environment_configs = {
        dev = {
          description = "Development rate limiting with relaxed limits"
          treatments = [
            {
              name           = "off"
              configurations = "{\"enabled\": false, \"debug\": true}"
              description    = "Disabled with debug logging"
            },
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 10000, \"debug\": true}"
              description    = "Relaxed limits for development"
            }
          ]
        }
        
        staging = {
          description = "Staging rate limiting with monitoring"
          treatments = [
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 2000, \"monitoring\": true}"
              description    = "Production-like with monitoring"
            }
          ]
        }
        
        prod = {
          description = "Production rate limiting with strict controls"
          treatments = [
            {
              name           = "standard"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 1000, \"strict_mode\": true}"
              description    = "Production with strict enforcement"
            },
            {
              name           = "restricted"
              configurations = "{\"enabled\": true, \"requests_per_minute\": 500, \"strict_mode\": true}"
              description    = "Restricted mode for high load"
            }
          ]
          rules = [
            {
              treatment = "restricted"
              size      = 0  # Manual activation only
            }
          ]
        }
      }
    }
  ]
}

# example.tfvars
workspace_name   = "Default"
environment_name = "dev"
is_production    = false

# Environment files
# environments/dev.tfvars
environment_name = "dev"
is_production    = false

# environments/staging.tfvars  
environment_name = "staging"
is_production    = false

# environments/prod.tfvars
environment_name = "prod"
is_production    = true
```

**Usage:**
```bash
# Deploy to different environments
terraform apply -var-file="environments/dev.tfvars" -var="split_api_key=your-key"
terraform apply -var-file="environments/staging.tfvars" -var="split_api_key=your-key"
terraform apply -var-file="environments/prod.tfvars" -var="split_api_key=your-key"
```

---

### Feature Flag Lifecycle Management

Example showing feature flags in different lifecycle stages.

```hcl
# main.tf
module "lifecycle_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Default"
  environment_name    = var.environment_name
  is_production       = var.is_production
  traffic_type_name   = "user"

  feature_flags = [
    # Development stage feature
    {
      name              = "experimental-ui"
      description       = "Experimental UI components"
      default_treatment = "off"
      environments      = ["dev"]  # Dev only
      lifecycle_stage   = "development"
      category          = "feature"
      
      treatments = [
        {
          name           = "off"
          configurations = "{\"enabled\": false}"
          description    = "Experimental UI disabled"
        },
        {
          name           = "on"
          configurations = "{\"enabled\": true, \"debug_mode\": true}"
          description    = "Experimental UI enabled with debug"
        }
      ]
      
      rules = [
        {
          treatment = "on"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "user_type"
              strings   = ["developer", "designer"]
            }
          }
        }
      ]
    },
    
    # Testing stage feature
    {
      name              = "payment-optimization"
      description       = "Payment flow optimization"
      default_treatment = "original"
      environments      = ["dev", "staging"]  # Dev and staging
      lifecycle_stage   = "testing"
      category          = "experiment"
      
      treatments = [
        {
          name           = "original"
          configurations = "{\"flow_version\": \"v1\"}"
          description    = "Original payment flow"
        },
        {
          name           = "optimized"
          configurations = "{\"flow_version\": \"v2\", \"analytics_tracking\": true}"
          description    = "Optimized payment flow with tracking"
        }
      ]
      
      rules = [
        {
          treatment = "optimized"
          size      = 50  # 50% A/B test
        }
      ]
    },
    
    # Production stage feature
    {
      name              = "advanced-search"
      description       = "Advanced search functionality"
      default_treatment = "basic"
      environments      = ["dev", "staging", "prod"]  # All environments
      lifecycle_stage   = "production"
      category          = "feature"
      
      treatments = [
        {
          name           = "basic"
          configurations = "{\"search_type\": \"basic\"}"
          description    = "Basic search functionality"
        },
        {
          name           = "advanced"
          configurations = "{\"search_type\": \"advanced\", \"ai_suggestions\": true}"
          description    = "Advanced search with AI suggestions"
        }
      ]
      
      environment_configs = {
        dev = {
          rules = [
            {
              treatment = "advanced"
              size      = 100  # All users in dev
            }
          ]
        }
        
        staging = {
          rules = [
            {
              treatment = "advanced"
              size      = 75  # 75% in staging
            }
          ]
        }
        
        prod = {
          rules = [
            {
              treatment = "advanced"
              size      = 25  # Conservative 25% in prod
              condition = {
                matcher = {
                  type      = "IN_SEGMENT"
                  attribute = "user_tier"
                  strings   = ["premium", "enterprise"]
                }
              }
            }
          ]
        }
      }
    },
    
    # Deprecated feature (being phased out)
    {
      name              = "legacy-dashboard"
      description       = "Legacy dashboard (being deprecated)"
      default_treatment = "new_dashboard"
      environments      = ["prod"]  # Prod only for migration
      lifecycle_stage   = "deprecated"
      category          = "feature"
      
      treatments = [
        {
          name           = "legacy_dashboard"
          configurations = "{\"dashboard_version\": \"v1\"}"
          description    = "Legacy dashboard (deprecated)"
        },
        {
          name           = "new_dashboard"
          configurations = "{\"dashboard_version\": \"v2\"}"
          description    = "New dashboard"
        }
      ]
      
      rules = [
        {
          treatment = "legacy_dashboard"
          size      = 5  # Only 5% still on legacy
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "migration_status"
              strings   = ["pending_migration"]
            }
          }
        }
      ]
    }
  ]
}
```

---

## ðŸ§ª Testing and Validation Examples

### Feature Flag Testing

```hcl
# test-main.tf
module "test_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = "Test-Workspace"
  environment_name    = "test"
  is_production      = false
  traffic_type_name  = "user"

  feature_flags = [
    # Test feature flag validation
    {
      name              = "validation-test"
      description       = "Feature flag for testing validation rules"
      default_treatment = "control"
      environments      = ["test"]
      lifecycle_stage   = "development"
      category          = "feature"
      
      treatments = [
        {
          name           = "control"
          configurations = "{\"test\": \"control_value\"}"
          description    = "Control treatment for testing"
        },
        {
          name           = "test_variant"
          configurations = "{\"test\": \"test_value\", \"additional_config\": true}"
          description    = "Test variant with additional configuration"
        }
      ]
      
      rules = [
        {
          treatment = "test_variant"
          size      = 100
          condition = {
            matcher = {
              type      = "IN_SEGMENT"
              attribute = "test_segment"
              strings   = ["test_users"]
            }
          }
        }
      ]
    }
  ]
}

# Test outputs
output "test_results" {
  description = "Test validation results"
  value = {
    workspace_id           = module.test_feature_flags.workspace_id
    environment_id         = module.test_feature_flags.environment_id
    filtered_flags         = module.test_feature_flags.filtered_feature_flags
    merged_flags          = module.test_feature_flags.merged_feature_flags
    feature_flags_summary = module.test_feature_flags.feature_flags_summary
  }
}
```

## ðŸ“‹ Usage Patterns

### 1. Local Development Workflow

```bash
# 1. Start with development
terraform workspace new development
terraform apply -var-file="environments/dev.tfvars" -var="split_api_key=$API_KEY"

# 2. Test in staging
terraform workspace new staging  
terraform apply -var-file="environments/staging.tfvars" -var="split_api_key=$API_KEY"

# 3. Deploy to production
terraform workspace new production
terraform apply -var-file="environments/prod.tfvars" -var="split_api_key=$API_KEY"
```

### 2. Feature Flag Lifecycle

```bash
# Create experimental feature (dev only)
terraform apply -var-file="dev-experiment.tfvars"

# Promote to testing (dev + staging)
terraform apply -var-file="testing-phase.tfvars"

# Production release (all environments)
terraform apply -var-file="production-release.tfvars"

# Deprecation (remove from non-prod)
terraform apply -var-file="deprecation.tfvars"
```

### 3. Emergency Response

```bash
# Activate killswitch via Terraform
terraform apply -var="emergency_mode=true" -target="module.banking_feature_flags.split_split_definition.system-maintenance"

# Or manually via Split.io dashboard
# Navigate to feature flag and change treatment
```

## ðŸ”§ Advanced Module Patterns

### Dynamic Configuration with External Files

```hcl
# dynamic-config-example.tf
locals {
  # Read feature flag config from external JSON file
  feature_config = jsondecode(file("${path.module}/feature-flags.json"))
  
  # Transform external config to module format
  generated_flags = [
    for config in local.feature_config.features : {
      name              = config.name
      description       = config.description
      default_treatment = config.default_treatment
      environments      = config.environments
      lifecycle_stage   = config.lifecycle_stage
      category          = config.category
      treatments        = config.treatments
      rules            = try(config.rules, [])
      environment_configs = try(config.environment_configs, {})
    }
  ]
}

module "dynamic_feature_flags" {
  source = "../../modules/split-feature-flags"

  split_api_key       = var.split_api_key
  workspace_name      = var.workspace_name
  environment_name    = var.environment_name
  is_production       = var.is_production
  traffic_type_name   = "user"

  feature_flags = local.generated_flags
}
```

### Conditional Feature Flag Deployment

```hcl
# conditional-deployment.tf
locals {
  # Only deploy experimental features in non-production
  experimental_features = var.is_production ? [] : [
    {
      name = "experimental-ui"
      description = "Experimental UI components"
      default_treatment = "off"
      environments = ["dev", "staging"]
      treatments = [
        {
          name = "off"
          configurations = "{\"enabled\": false}"
        },
        {
          name = "on"
          configurations = "{\"enabled\": true}"
        }
      ]
    }
  ]
  
  # Combine stable and experimental features
  all_features = concat(var.stable_features, local.experimental_features)
}

module "conditional_flags" {
  source = "../../modules/split-feature-flags"
  
  split_api_key = var.split_api_key
  workspace_name = var.workspace_name
  environment_name = var.environment_name
  is_production = var.is_production
  traffic_type_name = "user"
  
  feature_flags = local.all_features
}
```

These examples provide comprehensive coverage of different Terraform module usage patterns, making it easy for users to find the right configuration approach for their needs.